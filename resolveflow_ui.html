<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ResolveFlow</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0f1119;--surface:#161822;--surface2:#1c1f2e;--surface3:#222639;
  --accent:#e94560;--accent2:#c73a52;--text:#eaedf3;--text2:#8892a8;--text3:#505672;
  --green:#4ade80;--green-dark:#16a34a;--orange:#f59e0b;--blue:#3b82f6;
  --border:#262a3e;--border2:#353a52;
  --radius:8px;--radius-lg:12px;--transition:0.18s ease;
  --doc-bg:#1a1d2e;
}
html,body{height:100%;overflow:hidden}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column}
button{cursor:pointer;font-family:inherit;border:none;border-radius:var(--radius);transition:all var(--transition)}
button:hover{filter:brightness(1.15)}
button:active{transform:scale(0.97)}
input,select,textarea{font-family:inherit;background:var(--surface2);color:var(--text);border:1px solid var(--border);border-radius:var(--radius);padding:8px 12px;outline:none;transition:border var(--transition)}
input:focus,select:focus,textarea:focus{border-color:var(--accent)}
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--border2)}

.btn{padding:8px 18px;font-size:13px;font-weight:600;border-radius:var(--radius);display:inline-flex;align-items:center;gap:6px}
.btn-accent{background:var(--accent);color:#fff}
.btn-green{background:var(--green-dark);color:#fff}
.btn-blue{background:var(--blue);color:#fff}
.btn-secondary{background:var(--surface2);color:var(--text2);border:1px solid var(--border)}
.btn-ghost{background:transparent;color:var(--text2);padding:6px 12px}
.btn-ghost:hover{background:var(--surface2)}
.btn-sm{padding:5px 12px;font-size:12px}
.btn-lg{padding:12px 28px;font-size:15px;border-radius:var(--radius-lg)}
.badge{display:inline-block;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:600}
.badge-sony{background:#3b82f620;color:#60a5fa}
.badge-dji{background:#f59e0b20;color:#fbbf24}
.badge-unknown{background:#64748b20;color:#94a3b8}
.badge-transcribed{background:#4ade8020;color:#4ade80}
.badge-pending{background:#f59e0b20;color:#f59e0b}

/* Header */
.header{display:flex;align-items:center;padding:0 20px;height:52px;background:var(--surface);border-bottom:1px solid var(--border);gap:16px;flex-shrink:0;z-index:100}
.logo{font-size:18px;font-weight:800;color:var(--accent);letter-spacing:-0.5px}
.project-name{color:var(--text2);font-size:13px}
.header-spacer{flex:1}
.resolve-status{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text2)}
.resolve-dot{width:8px;height:8px;border-radius:50%;background:#555;flex-shrink:0}
.resolve-dot.on{background:var(--green);box-shadow:0 0 6px var(--green)}
.resolve-dot.off{background:var(--accent)}

/* Tab Nav */
.tab-nav{display:flex;gap:0;background:var(--surface);border-bottom:1px solid var(--border);padding:0 20px;flex-shrink:0}
.tab-btn{padding:12px 24px;font-size:13px;font-weight:700;letter-spacing:0.5px;text-transform:uppercase;color:var(--text3);background:transparent;border:none;border-bottom:2px solid transparent;border-radius:0;transition:all var(--transition);position:relative}
.tab-btn:hover{color:var(--text2);filter:none}
.tab-btn.active{color:var(--accent);border-bottom-color:var(--accent)}
.tab-btn .tab-count{font-size:11px;font-weight:600;background:var(--surface2);color:var(--text2);padding:1px 6px;border-radius:8px;margin-left:6px}

/* Tab content */
.tab-content{flex:1;overflow:hidden;display:none}
.tab-content.active{display:flex;flex-direction:column}

/* ‚ïê‚ïê‚ïê TAB 1: CLIPS ‚ïê‚ïê‚ïê */
.clips-stats{display:flex;gap:24px;padding:16px 24px;background:var(--surface);border-bottom:1px solid var(--border);flex-shrink:0;flex-wrap:wrap}
.stat-item{display:flex;flex-direction:column;gap:2px}
.stat-value{font-size:20px;font-weight:700;color:var(--text)}
.stat-label{font-size:11px;color:var(--text2);text-transform:uppercase;letter-spacing:0.5px}
.clips-toolbar{display:flex;align-items:center;gap:10px;padding:12px 24px;flex-shrink:0;flex-wrap:wrap}
.filter-chips{display:flex;gap:6px}
.chip{padding:5px 14px;font-size:12px;font-weight:600;border-radius:20px;background:var(--surface2);color:var(--text2);border:1px solid var(--border);cursor:pointer;transition:all var(--transition)}
.chip:hover{border-color:var(--text3)}
.chip.active{background:var(--accent);color:#fff;border-color:var(--accent)}
.sort-group{display:flex;align-items:center;gap:6px;margin-left:auto}
.sort-group label{font-size:12px;color:var(--text3)}
.sort-group select{padding:4px 8px;font-size:12px}

.clips-body{flex:1;display:flex;overflow:hidden}
.clips-grid-wrap{flex:1;overflow-y:auto;padding:16px 24px}
.clips-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px}
.clip-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);overflow:hidden;cursor:pointer;transition:all var(--transition)}
.clip-card:hover{border-color:var(--border2);transform:translateY(-2px);box-shadow:0 8px 24px #0004}
.clip-card.selected{border-color:var(--accent);box-shadow:0 0 0 1px var(--accent)}
.clip-thumb{width:100%;aspect-ratio:16/9;background:var(--surface2);object-fit:cover;display:block}
.clip-info{padding:10px 12px}
.clip-name{font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.clip-meta{display:flex;align-items:center;gap:6px;margin-top:4px;font-size:12px;color:var(--text2)}
.clip-duration{font-variant-numeric:tabular-nums}
.clip-preview-text{font-size:11px;color:var(--text3);margin-top:6px;line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}

/* Clip detail panel */
.clip-detail{width:420px;background:var(--surface);border-left:1px solid var(--border);overflow-y:auto;flex-shrink:0;display:none;padding:0}
.clip-detail.open{display:block}
.clip-detail-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--border)}
.clip-detail-header h3{font-size:15px;font-weight:700}
.clip-detail-close{background:transparent;color:var(--text2);font-size:18px;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:var(--radius)}
.clip-detail-thumb{width:100%;aspect-ratio:16/9;object-fit:cover;background:var(--surface2);display:block}
.clip-detail-body{padding:20px}
.detail-row{display:flex;justify-content:space-between;padding:6px 0;font-size:13px;border-bottom:1px solid var(--border)}
.detail-row .label{color:var(--text2)}
.detail-row .value{font-weight:600;text-align:right;max-width:60%;word-break:break-all}
.clip-transcript{margin-top:20px}
.clip-transcript h4{font-size:13px;font-weight:700;margin-bottom:10px;color:var(--text2);text-transform:uppercase;letter-spacing:0.5px}
.transcript-segment{font-size:13px;line-height:1.7;color:var(--text);padding:4px 0}
.transcript-segment .tc{color:var(--text3);font-size:11px;font-variant-numeric:tabular-nums;margin-right:8px}
.no-transcript-msg{color:var(--text3);font-size:13px;font-style:italic}

/* ‚ïê‚ïê‚ïê TAB 2: SCRIPTS ‚ïê‚ïê‚ïê */
.scripts-layout{flex:1;display:flex;overflow:hidden}
.scripts-left{width:420px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;flex-shrink:0}
.scripts-left-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;flex-shrink:0}
.scripts-left-header h3{font-size:14px;font-weight:700;flex:1}
.clip-selector{flex:1;overflow-y:auto;padding:8px 0}
.clip-select-item{display:flex;align-items:center;gap:10px;padding:8px 20px;cursor:pointer;transition:background var(--transition)}
.clip-select-item:hover{background:var(--surface2)}
.clip-select-item input[type="checkbox"]{accent-color:var(--accent);width:16px;height:16px;flex-shrink:0}
.clip-select-thumb{width:48px;height:27px;border-radius:4px;object-fit:cover;background:var(--surface2);flex-shrink:0}
.clip-select-info{flex:1;min-width:0}
.clip-select-name{font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.clip-select-meta{font-size:11px;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.selection-summary{padding:12px 20px;border-top:1px solid var(--border);font-size:12px;color:var(--text2);display:flex;align-items:center;gap:8px;flex-shrink:0}
.selection-summary strong{color:var(--text)}

/* Create script form */
.create-script-form{padding:20px;border-top:1px solid var(--border);flex-shrink:0;background:var(--surface2)}
.form-label{font-size:12px;font-weight:600;color:var(--text2);margin-bottom:6px;display:block;text-transform:uppercase;letter-spacing:0.3px}
.form-group{margin-bottom:14px}
.form-group input,.form-group select,.form-group textarea{width:100%;font-size:13px}
.form-group textarea{resize:vertical;min-height:60px}
.duration-presets{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:8px}
.dur-btn{padding:4px 10px;font-size:11px;font-weight:600;border-radius:14px;background:var(--surface);color:var(--text2);border:1px solid var(--border);cursor:pointer;transition:all var(--transition)}
.dur-btn:hover{border-color:var(--text3)}
.dur-btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}
.ai-note{font-size:11px;color:var(--text3);font-style:italic;margin-top:8px;line-height:1.4}

/* Scripts right panel */
.scripts-right{flex:1;display:flex;flex-direction:column;overflow:hidden}
.scripts-right-header{display:flex;align-items:center;gap:12px;padding:16px 24px;border-bottom:1px solid var(--border);flex-shrink:0;flex-wrap:wrap}
.scripts-right-header select{font-size:13px;flex:1;max-width:300px}
.script-doc{flex:1;overflow-y:auto;padding:32px}
.script-doc-inner{max-width:720px;margin:0 auto}
.script-title{font-size:22px;font-weight:800;margin-bottom:8px}
.script-subtitle{font-size:13px;color:var(--text2);margin-bottom:24px}
.script-section{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);margin-bottom:12px;overflow:hidden;transition:box-shadow var(--transition)}
.script-section:hover{box-shadow:0 4px 16px #0003}
.script-section-header{display:flex;align-items:center;gap:10px;padding:12px 16px;background:var(--surface2);border-bottom:1px solid var(--border)}
.script-section-name{font-size:14px;font-weight:700;flex:1}
.script-section-name[contenteditable]{outline:none;border-bottom:1px dashed transparent}
.script-section-name[contenteditable]:focus{border-bottom-color:var(--accent)}
.script-section-dur{font-size:12px;color:var(--text2);font-variant-numeric:tabular-nums}
.script-section-body{padding:14px 16px}
.script-clip-ref{font-size:12px;color:var(--blue);font-weight:600;margin-bottom:6px}
.script-section-text{font-size:13px;line-height:1.7;color:var(--text)}
.script-section-controls{display:flex;gap:4px;padding:8px 16px;border-top:1px solid var(--border)}
.script-total{margin-top:20px;padding:16px;text-align:right;font-size:14px;color:var(--text2)}
.script-total strong{color:var(--text);font-size:18px}
.script-empty{text-align:center;padding:80px 20px;color:var(--text3)}
.script-empty h3{font-size:18px;color:var(--text2);margin-bottom:8px}
.script-actions{display:flex;gap:8px;padding:16px 24px;border-top:1px solid var(--border);flex-shrink:0}

/* ‚ïê‚ïê‚ïê TAB 3: TIMELINE ‚ïê‚ïê‚ïê */
.timeline-header{display:flex;align-items:center;gap:12px;padding:12px 24px;background:var(--surface);border-bottom:1px solid var(--border);flex-shrink:0}
.timeline-header h3{font-size:16px;font-weight:700;flex:1}
.timeline-body{flex:1;display:flex;overflow:hidden}
.timeline-script-panel{width:55%;overflow-y:auto;padding:24px 32px;background:var(--doc-bg);border-right:1px solid var(--border)}
.timeline-preview-panel{width:45%;display:flex;flex-direction:column;overflow:hidden}

/* Timeline script document */
.tl-section-header{font-size:12px;font-weight:700;color:var(--accent);text-transform:uppercase;letter-spacing:0.5px;margin:24px 0 12px;padding-bottom:8px;border-bottom:1px solid var(--border)}
.tl-section-header:first-child{margin-top:0}
.tl-segment{display:flex;gap:14px;padding:12px 14px;border-radius:var(--radius);cursor:pointer;transition:all var(--transition);margin-bottom:4px}
.tl-segment:hover{background:var(--surface2)}
.tl-segment.active{background:var(--accent)15;border-left:3px solid var(--accent);padding-left:11px}
.tl-segment-thumb{width:64px;height:36px;border-radius:4px;object-fit:cover;background:var(--surface2);flex-shrink:0}
.tl-segment-content{flex:1;min-width:0}
.tl-segment-speaker{font-size:11px;font-weight:700;color:var(--blue);margin-bottom:2px}
.tl-segment-text{font-size:13px;line-height:1.6;color:var(--text)}
.tl-segment-tc{font-size:11px;color:var(--text3);font-variant-numeric:tabular-nums;flex-shrink:0;text-align:right;min-width:50px;padding-top:2px}

/* Preview panel */
.preview-frame{flex:1;display:flex;align-items:center;justify-content:center;background:var(--bg);padding:20px;min-height:0}
.preview-frame img{max-width:100%;max-height:100%;object-fit:contain;border-radius:var(--radius)}
.preview-placeholder{color:var(--text3);font-size:14px;text-align:center}
.preview-info{padding:16px 20px;border-top:1px solid var(--border);background:var(--surface);flex-shrink:0}
.preview-clip-name{font-size:14px;font-weight:700;margin-bottom:4px}
.preview-clip-tc{font-size:12px;color:var(--text2);font-variant-numeric:tabular-nums}
.preview-controls{display:flex;align-items:center;justify-content:center;gap:8px;padding:12px 20px;border-top:1px solid var(--border);background:var(--surface);flex-shrink:0}
.preview-controls button{width:40px;height:40px;border-radius:50%;background:var(--surface2);color:var(--text);font-size:16px;display:flex;align-items:center;justify-content:center;border:1px solid var(--border)}
.preview-controls button.play-btn{width:48px;height:48px;background:var(--accent);border:none;font-size:18px}
.preview-segment-info{padding:12px 20px;border-top:1px solid var(--border);background:var(--surface);font-size:12px;color:var(--text2);flex-shrink:0}

/* Filmstrip timeline */
.filmstrip{height:80px;background:var(--surface);border-top:1px solid var(--border);display:flex;overflow-x:auto;padding:8px 12px;gap:4px;flex-shrink:0;align-items:stretch}
.filmstrip-block{flex-shrink:0;background:var(--surface2);border:1px solid var(--border);border-radius:6px;display:flex;align-items:center;gap:6px;padding:6px 8px;cursor:pointer;transition:all var(--transition);overflow:hidden}
.filmstrip-block:hover{border-color:var(--border2)}
.filmstrip-block.active{border-color:var(--accent);box-shadow:0 0 0 1px var(--accent)}
.filmstrip-thumb{width:40px;height:28px;border-radius:3px;object-fit:cover;background:var(--bg);flex-shrink:0}
.filmstrip-text{font-size:10px;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;min-width:0}
.filmstrip-dur{font-size:10px;color:var(--text3);flex-shrink:0;font-variant-numeric:tabular-nums}
.filmstrip-total{display:flex;align-items:center;padding:0 12px;font-size:11px;color:var(--text3);flex-shrink:0;font-weight:600}

/* Loading spinner */
.spinner{width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.6s linear infinite;display:inline-block}
@keyframes spin{to{transform:rotate(360deg)}}

/* Toast */
.toast-container{position:fixed;bottom:20px;right:20px;z-index:9999;display:flex;flex-direction:column;gap:8px}
.toast{padding:12px 20px;border-radius:var(--radius);font-size:13px;font-weight:600;animation:slideIn 0.3s ease;box-shadow:0 8px 24px #0006}
.toast.success{background:var(--green-dark);color:#fff}
.toast.error{background:var(--accent);color:#fff}
.toast.info{background:var(--blue);color:#fff}
@keyframes slideIn{from{transform:translateX(100px);opacity:0}to{transform:translateX(0);opacity:1}}

/* Responsive */
@media(max-width:900px){
  .clips-body{flex-direction:column}
  .clip-detail{width:100%;border-left:none;border-top:1px solid var(--border)}
  .scripts-layout{flex-direction:column}
  .scripts-left{width:100%;max-height:50vh}
  .timeline-body{flex-direction:column}
  .timeline-script-panel,.timeline-preview-panel{width:100%}
  .timeline-script-panel{max-height:50vh}
}
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div class="logo">ResolveFlow</div>
  <div class="project-name" id="projectName">Loading‚Ä¶</div>
  <div class="header-spacer"></div>
  <div class="resolve-status">
    <div class="resolve-dot" id="resolveDot"></div>
    <span id="resolveLabel">Checking‚Ä¶</span>
  </div>
  <button class="btn btn-secondary btn-sm" onclick="doIngest()">‚ü≥ Rescan</button>
  <button class="btn btn-accent btn-sm" id="transcribeBtn" onclick="doTranscribe()">Transcribe All</button>
</div>

<!-- Tab Nav -->
<div class="tab-nav">
  <button class="tab-btn active" data-tab="clips" onclick="switchTab('clips')">Clips <span class="tab-count" id="clipCount">0</span></button>
  <button class="tab-btn" data-tab="scripts" onclick="switchTab('scripts')">Scripts <span class="tab-count" id="scriptCount">0</span></button>
  <button class="tab-btn" data-tab="timeline" onclick="switchTab('timeline')">Timeline</button>
</div>

<!-- ‚ïê‚ïê‚ïê CLIPS TAB ‚ïê‚ïê‚ïê -->
<div class="tab-content active" id="tab-clips">
  <div class="clips-stats" id="clipsStats"></div>
  <div class="clips-toolbar">
    <div class="filter-chips">
      <button class="chip active" data-filter="all" onclick="setFilter('all',this)">All</button>
      <button class="chip" data-filter="Sony" onclick="setFilter('Sony',this)">Sony</button>
      <button class="chip" data-filter="DJI" onclick="setFilter('DJI',this)">DJI</button>
      <button class="chip" data-filter="transcribed" onclick="setFilter('transcribed',this)">Transcribed</button>
      <button class="chip" data-filter="pending" onclick="setFilter('pending',this)">Pending</button>
    </div>
    <div class="sort-group">
      <label>Sort:</label>
      <select id="sortSelect" onchange="renderClips()">
        <option value="name">Name</option>
        <option value="duration">Duration</option>
        <option value="camera">Device</option>
      </select>
    </div>
  </div>
  <div class="clips-body">
    <div class="clips-grid-wrap">
      <div class="clips-grid" id="clipsGrid"></div>
    </div>
    <div class="clip-detail" id="clipDetail"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê SCRIPTS TAB ‚ïê‚ïê‚ïê -->
<div class="tab-content" id="tab-scripts">
  <div class="scripts-layout">
    <div class="scripts-left">
      <div class="scripts-left-header">
        <h3>Select Clips</h3>
        <button class="btn btn-ghost btn-sm" onclick="selectAllClips()">Select All</button>
        <button class="btn btn-ghost btn-sm" onclick="clearClipSelection()">Clear</button>
      </div>
      <div class="clip-selector" id="clipSelector"></div>
      <div class="selection-summary" id="selectionSummary">
        <strong>0</strong> clips selected ¬∑ <span>0:00</span> total
      </div>
      <div class="create-script-form">
        <div class="form-group">
          <label class="form-label">Script Name</label>
          <input type="text" id="scriptNameInput" placeholder="My Edit">
        </div>
        <div class="form-group">
          <label class="form-label">Target Duration</label>
          <div class="duration-presets" id="durPresets">
            <button class="dur-btn" data-dur="30">30s</button>
            <button class="dur-btn" data-dur="60">1min</button>
            <button class="dur-btn active" data-dur="120">2min</button>
            <button class="dur-btn" data-dur="300">5min</button>
            <button class="dur-btn" data-dur="600">10min</button>
            <button class="dur-btn" data-dur="0">Full</button>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Style</label>
          <select id="styleSelect">
            <option>Highlight Reel</option>
            <option>Documentary</option>
            <option>Interview</option>
            <option>Social Media</option>
            <option>Tutorial</option>
            <option>Custom</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Instructions</label>
          <textarea id="promptInput" placeholder="What should this video be about? What's the story?" rows="3"></textarea>
        </div>
        <button class="btn btn-accent btn-lg" style="width:100%" id="generateBtn" onclick="generateScript()">‚ú® Generate with AI</button>
        <div class="ai-note">AI will arrange and trim existing clips ‚Äî it cannot create new dialog.</div>
      </div>
    </div>
    <div class="scripts-right">
      <div class="scripts-right-header">
        <select id="scriptSelect" onchange="loadScript(this.value)">
          <option value="">‚Äî Select a script ‚Äî</option>
        </select>
        <button class="btn btn-secondary btn-sm" onclick="duplicateScript()">Duplicate</button>
        <button class="btn btn-secondary btn-sm" style="color:var(--accent)" onclick="deleteScript()">Delete</button>
      </div>
      <div class="script-doc" id="scriptDoc">
        <div class="script-empty">
          <h3>No script loaded</h3>
          <p>Select clips on the left and generate a script with AI,<br>or choose an existing script above.</p>
        </div>
      </div>
      <div class="script-actions" id="scriptActions" style="display:none">
        <div style="flex:1"></div>
        <button class="btn btn-green btn-lg" onclick="openInTimeline()">Open in Timeline ‚Üí</button>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê TIMELINE TAB ‚ïê‚ïê‚ïê -->
<div class="tab-content" id="tab-timeline">
  <div class="timeline-header">
    <button class="btn btn-ghost btn-sm" onclick="switchTab('scripts')">‚Üê Scripts</button>
    <h3 id="timelineTitle">No script loaded</h3>
    <span id="timelineDuration" style="font-size:13px;color:var(--text2)"></span>
    <div style="flex:1"></div>
    <button class="btn btn-secondary" onclick="exportEDL()">Export EDL</button>
    <button class="btn btn-green btn-lg" onclick="sendToResolve()">üé¨ Send to Resolve</button>
  </div>
  <div class="timeline-body">
    <div class="timeline-script-panel" id="timelineScriptPanel"></div>
    <div class="timeline-preview-panel">
      <div class="preview-frame" id="previewFrame">
        <div class="preview-placeholder">Select a segment to preview</div>
      </div>
      <div class="preview-controls">
        <button onclick="prevSegment()">‚èÆ</button>
        <button class="play-btn">‚ñ∂</button>
        <button onclick="nextSegment()">‚è≠</button>
      </div>
      <div class="preview-info" id="previewInfo">
        <div class="preview-clip-name">‚Äî</div>
        <div class="preview-clip-tc">‚Äî</div>
      </div>
      <div class="preview-segment-info" id="previewSegmentInfo">Select a segment to see details</div>
    </div>
  </div>
  <div class="filmstrip" id="filmstrip"></div>
</div>

<div class="toast-container" id="toasts"></div>

<script>
// ‚îÄ‚îÄ State ‚îÄ‚îÄ
const S = {
  activeTab: 'clips',
  clips: [],
  filter: 'all',
  selectedClipDetail: null,
  selectedClips: new Set(),
  scripts: [],
  currentScript: null,
  currentScriptData: null,
  timelineScript: null,
  timelineSegmentIndex: 0,
  transcripts: {},
  targetDuration: 120,
};

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
const api = async (path, opts) => {
  const r = await fetch(`/api${path}`, opts);
  if (!r.ok) throw new Error(`API ${r.status}`);
  const ct = r.headers.get('content-type') || '';
  return ct.includes('json') ? r.json() : r.text();
};
const apiPost = (path, body) => api(path, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});

function fmtDur(s) {
  if (!s || s < 0) return '0:00';
  const m = Math.floor(s / 60), sec = Math.floor(s % 60);
  return `${m}:${sec.toString().padStart(2, '0')}`;
}
function fmtDurLong(s) {
  if (!s) return '0s';
  if (s < 60) return `${Math.round(s)}s`;
  const m = Math.floor(s / 60), sec = Math.round(s % 60);
  return sec ? `${m}m ${sec}s` : `${m}m`;
}

function toast(msg, type='info') {
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.textContent = msg;
  $('#toasts').appendChild(el);
  setTimeout(() => el.remove(), 4000);
}

const clipColors = ['#e94560','#3b82f6','#10b981','#f59e0b','#8b5cf6','#ec4899','#06b6d4','#f97316'];
function clipColor(id) { return clipColors[(id - 1) % clipColors.length]; }

// ‚îÄ‚îÄ Tab switching ‚îÄ‚îÄ
function switchTab(tab) {
  S.activeTab = tab;
  $$('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === tab));
  $$('.tab-content').forEach(c => c.classList.toggle('active', c.id === `tab-${tab}`));
  if (tab === 'scripts') { renderClipSelector(); loadScriptsList(); }
  if (tab === 'timeline' && S.timelineScript) renderTimeline();
}

// ‚îÄ‚îÄ Data loading ‚îÄ‚îÄ
async function loadAll() {
  try {
    const [project, clips, resolveStatus] = await Promise.all([
      api('/project'), api('/clips'), api('/resolve/status')
    ]);
    S.clips = clips;
    $('#projectName').textContent = project.name || project.path;
    $('#clipCount').textContent = clips.length;
    $('#resolveDot').className = `resolve-dot ${resolveStatus.connected ? 'on' : 'off'}`;
    $('#resolveLabel').textContent = resolveStatus.connected
      ? `Resolve: ${resolveStatus.project || 'Connected'}` : 'Resolve: Offline';
    renderClipsStats();
    renderClips();
    loadScriptsList();
  } catch(e) { toast('Failed to load: ' + e.message, 'error'); }
}

// ‚îÄ‚îÄ CLIPS TAB ‚îÄ‚îÄ
function renderClipsStats() {
  const clips = S.clips;
  const total = clips.length;
  const dur = clips.reduce((a, c) => a + (c.duration_seconds || 0), 0);
  const sony = clips.filter(c => c.camera === 'Sony').length;
  const dji = clips.filter(c => c.camera === 'DJI').length;
  const transcribed = clips.filter(c => c.has_transcript).length;
  $('#clipsStats').innerHTML = `
    <div class="stat-item"><div class="stat-value">${total}</div><div class="stat-label">Clips</div></div>
    <div class="stat-item"><div class="stat-value">${fmtDurLong(dur)}</div><div class="stat-label">Total Duration</div></div>
    <div class="stat-item"><div class="stat-value">${sony}</div><div class="stat-label">Sony</div></div>
    <div class="stat-item"><div class="stat-value">${dji}</div><div class="stat-label">DJI</div></div>
    <div class="stat-item"><div class="stat-value">${transcribed}/${total}</div><div class="stat-label">Transcribed</div></div>
  `;
}

function setFilter(f, el) {
  S.filter = f;
  $$('.filter-chips .chip').forEach(c => c.classList.toggle('active', c === el));
  renderClips();
}

function getFilteredClips() {
  let clips = [...S.clips];
  if (S.filter === 'Sony') clips = clips.filter(c => c.camera === 'Sony');
  else if (S.filter === 'DJI') clips = clips.filter(c => c.camera === 'DJI');
  else if (S.filter === 'transcribed') clips = clips.filter(c => c.has_transcript);
  else if (S.filter === 'pending') clips = clips.filter(c => !c.has_transcript);

  const sort = $('#sortSelect').value;
  if (sort === 'name') clips.sort((a,b) => a.filename.localeCompare(b.filename));
  else if (sort === 'duration') clips.sort((a,b) => (b.duration_seconds||0) - (a.duration_seconds||0));
  else if (sort === 'camera') clips.sort((a,b) => (a.camera||'').localeCompare(b.camera||''));
  return clips;
}

function renderClips() {
  const clips = getFilteredClips();
  const grid = $('#clipsGrid');
  grid.innerHTML = clips.map(c => `
    <div class="clip-card ${S.selectedClipDetail === c.id ? 'selected' : ''}" onclick="showClipDetail(${c.id})">
      <img class="clip-thumb" src="/api/thumbnails/${c.id}" onerror="this.style.background='var(--surface2)';this.src=''" loading="lazy">
      <div class="clip-info">
        <div class="clip-name">${c.filename}</div>
        <div class="clip-meta">
          <span class="clip-duration">${fmtDur(c.duration_seconds)}</span>
          <span class="badge badge-${(c.camera||'unknown').toLowerCase()}">${c.camera||'?'}</span>
          ${c.has_transcript ? '<span class="badge badge-transcribed">‚úì</span>' : '<span class="badge badge-pending">‚Ä¶</span>'}
        </div>
        ${c.transcript_preview ? `<div class="clip-preview-text">${escHtml(c.transcript_preview)}</div>` : ''}
      </div>
    </div>
  `).join('');
}

function escHtml(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

async function showClipDetail(id) {
  S.selectedClipDetail = id;
  renderClips();
  const clip = S.clips.find(c => c.id === id);
  if (!clip) return;

  const panel = $('#clipDetail');
  panel.classList.add('open');

  // Load transcript
  let transcriptHtml = '<div class="no-transcript-msg">No transcript available</div>';
  if (clip.has_transcript) {
    try {
      const t = await api(`/transcript/${id}`);
      if (t && t.segments && t.segments.length) {
        transcriptHtml = t.segments.map(s =>
          `<div class="transcript-segment"><span class="tc">[${fmtDur(s.start)}]</span>${escHtml(s.text)}</div>`
        ).join('');
        S.transcripts[id] = t;
      } else if (t && t.full_text) {
        transcriptHtml = `<div class="transcript-segment">${escHtml(t.full_text)}</div>`;
      }
    } catch(e) {}
  }

  panel.innerHTML = `
    <div class="clip-detail-header">
      <h3>${escHtml(clip.filename)}</h3>
      <button class="clip-detail-close" onclick="closeClipDetail()">‚úï</button>
    </div>
    <img class="clip-detail-thumb" src="/api/thumbnails/${id}" onerror="this.style.display='none'">
    <div class="clip-detail-body">
      <div class="detail-row"><span class="label">Duration</span><span class="value">${fmtDurLong(clip.duration_seconds)}</span></div>
      <div class="detail-row"><span class="label">Resolution</span><span class="value">${clip.resolution || '‚Äî'}</span></div>
      <div class="detail-row"><span class="label">Codec</span><span class="value">${clip.codec || '‚Äî'}</span></div>
      <div class="detail-row"><span class="label">Camera</span><span class="value">${clip.camera || '‚Äî'}</span></div>
      <div class="detail-row"><span class="label">FPS</span><span class="value">${clip.fps || '‚Äî'}</span></div>
      <div class="detail-row"><span class="label">Path</span><span class="value" style="font-size:11px">${escHtml(clip.relative_path || '')}</span></div>
      <div class="clip-transcript">
        <h4>Transcript</h4>
        ${transcriptHtml}
      </div>
    </div>
  `;
}

function closeClipDetail() {
  S.selectedClipDetail = null;
  $('#clipDetail').classList.remove('open');
  renderClips();
}

// ‚îÄ‚îÄ SCRIPTS TAB ‚îÄ‚îÄ
function renderClipSelector() {
  const clips = S.clips.filter(c => c.has_transcript);
  $('#clipSelector').innerHTML = clips.length ? clips.map(c => `
    <label class="clip-select-item">
      <input type="checkbox" ${S.selectedClips.has(c.id)?'checked':''} onchange="toggleClipSelect(${c.id},this.checked)">
      <img class="clip-select-thumb" src="/api/thumbnails/${c.id}" onerror="this.style.background='var(--surface2)'">
      <div class="clip-select-info">
        <div class="clip-select-name">${escHtml(c.filename)}</div>
        <div class="clip-select-meta">${fmtDur(c.duration_seconds)} ¬∑ ${escHtml((c.transcript_preview||'').slice(0,60))}</div>
      </div>
    </label>
  `).join('') : '<div style="padding:20px;color:var(--text3);text-align:center">No transcribed clips yet</div>';
  updateSelectionSummary();
}

function toggleClipSelect(id, checked) {
  if (checked) S.selectedClips.add(id); else S.selectedClips.delete(id);
  updateSelectionSummary();
}
function selectAllClips() {
  S.clips.filter(c => c.has_transcript).forEach(c => S.selectedClips.add(c.id));
  renderClipSelector();
}
function clearClipSelection() {
  S.selectedClips.clear();
  renderClipSelector();
}
function updateSelectionSummary() {
  const sel = [...S.selectedClips];
  const dur = sel.reduce((a, id) => {
    const c = S.clips.find(x => x.id === id);
    return a + (c ? c.duration_seconds || 0 : 0);
  }, 0);
  $('#selectionSummary').innerHTML = `<strong>${sel.length}</strong> clips selected ¬∑ <span>${fmtDurLong(dur)}</span> total`;
}

// Duration presets
document.addEventListener('click', e => {
  if (e.target.classList.contains('dur-btn')) {
    $$('.dur-btn').forEach(b => b.classList.remove('active'));
    e.target.classList.add('active');
    S.targetDuration = parseInt(e.target.dataset.dur) || 0;
  }
});

async function generateScript() {
  if (S.selectedClips.size === 0) { toast('Select at least one clip', 'error'); return; }
  const btn = $('#generateBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Generating‚Ä¶';
  try {
    const result = await apiPost('/ai/auto-edit', {
      clip_ids: [...S.selectedClips],
      target_duration: S.targetDuration || 9999,
      style: $('#styleSelect').value,
      prompt: $('#promptInput').value || ''
    });
    if (result.error) { toast(result.error, 'error'); return; }
    toast(`Script created: ${result.script_name}`, 'success');
    await loadScriptsList();
    if (result.script_id) {
      $('#scriptSelect').value = result.script_id;
      loadScript(result.script_id);
    }
  } catch(e) { toast('Generation failed: ' + e.message, 'error'); }
  finally { btn.disabled = false; btn.innerHTML = '‚ú® Generate with AI'; }
}

async function loadScriptsList() {
  try {
    S.scripts = await api('/scripts');
    $('#scriptCount').textContent = S.scripts.length;
    const sel = $('#scriptSelect');
    const curVal = sel.value;
    sel.innerHTML = '<option value="">‚Äî Select a script ‚Äî</option>' +
      S.scripts.map(s => `<option value="${s.id}">${escHtml(s.name)} (${fmtDurLong(s.target_duration_seconds)})</option>`).join('');
    if (curVal) sel.value = curVal;
  } catch(e) {}
}

async function loadScript(id) {
  if (!id) { renderScriptEmpty(); return; }
  try {
    const data = await api(`/script/${id}`);
    S.currentScript = id;
    S.currentScriptData = data;
    renderScript(data);
  } catch(e) { toast('Failed to load script', 'error'); }
}

function renderScriptEmpty() {
  S.currentScript = null;
  S.currentScriptData = null;
  $('#scriptDoc').innerHTML = `<div class="script-empty"><h3>No script loaded</h3><p>Select clips and generate with AI, or choose an existing script above.</p></div>`;
  $('#scriptActions').style.display = 'none';
}

const SEG_COLORS = ['#e94560','#4ecca3','#e9a645','#a78bfa','#38bdf8','#f472b6','#34d399','#fb923c','#818cf8','#22d3ee'];

function renderScript(data) {
  const script = data.script;
  const segments = data.segments || [];
  const totalDur = segments.reduce((a, s) => a + ((s.end_time||0) - (s.start_time||0)), 0);
  const inner = $('#scriptDoc');

  let html = `<div style="padding:24px;">
    <h2 style="font-size:20px;font-weight:700;margin-bottom:4px;color:var(--text)">${escHtml(script.name)}</h2>
    <p style="font-size:13px;color:var(--text3);margin-bottom:20px">${fmtDurLong(totalDur)} ¬∑ ${segments.length} segments</p>
    <div style="display:flex;gap:24px;">
      <!-- Outline column -->
      <div style="width:240px;flex-shrink:0;">
        <h4 style="font-size:12px;text-transform:uppercase;letter-spacing:1px;color:var(--text3);margin-bottom:12px">Outline</h4>`;

  segments.forEach((seg, i) => {
    const color = SEG_COLORS[i % SEG_COLORS.length];
    html += `<div style="padding:8px 10px;margin-bottom:4px;border-radius:6px;cursor:pointer;border-left:3px solid ${color};background:var(--surface);font-size:12px" onclick="scrollToSegText(${i})">
      <div style="font-weight:600;color:var(--text);margin-bottom:2px">${escHtml(seg.section_name || 'Section '+(i+1))}</div>
      <div style="color:var(--text3)">${escHtml(seg.filename||'')} ¬∑ ${fmtDur(seg.start_time)}‚Üí${fmtDur(seg.end_time)}</div>
    </div>`;
  });

  html += `</div>
      <!-- Full text column -->
      <div style="flex:1;min-width:0;">
        <h4 style="font-size:12px;text-transform:uppercase;letter-spacing:1px;color:var(--text3);margin-bottom:12px">Full Script</h4>`;

  segments.forEach((seg, i) => {
    const color = SEG_COLORS[i % SEG_COLORS.length];
    const text = seg.transcript_text || seg.notes || '';
    html += `<div id="seg-text-${i}" style="margin-bottom:20px;padding:16px;background:var(--doc-bg, #1e2235);border-radius:8px;border-left:3px solid ${color}">
      <div style="font-size:11px;color:${color};font-weight:700;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px">${escHtml(seg.section_name || 'Section '+(i+1))}</div>
      <div style="font-size:10px;color:var(--text3);margin-bottom:8px">${escHtml(seg.filename||'')} [${fmtDur(seg.start_time)} ‚Üí ${fmtDur(seg.end_time)}]</div>
      <p style="font-size:15px;line-height:1.8;color:var(--text);margin:0">${escHtml(text) || '<em style="color:var(--text3)">No transcript text for this segment</em>'}</p>
    </div>`;
  });

  html += `</div></div></div>`;
  inner.innerHTML = html;
  inner.style.overflowY = 'auto';
  $('#scriptActions').style.display = 'flex';
}

function scrollToSegText(idx) {
  const el = document.getElementById('seg-text-' + idx);
  if (el) el.scrollIntoView({behavior:'smooth', block:'center'});
}

async function updateSectionName(idx, name) {
  if (!S.currentScriptData) return;
  S.currentScriptData.segments[idx].section_name = name;
  await saveSegments();
}

async function moveSection(idx, dir) {
  if (!S.currentScriptData) return;
  const segs = S.currentScriptData.segments;
  const target = idx + dir;
  if (target < 0 || target >= segs.length) return;
  [segs[idx], segs[target]] = [segs[target], segs[idx]];
  segs.forEach((s, i) => s.order_index = i);
  await saveSegments();
  renderScript(S.currentScriptData);
}

async function removeSection(idx) {
  if (!S.currentScriptData) return;
  S.currentScriptData.segments.splice(idx, 1);
  S.currentScriptData.segments.forEach((s, i) => s.order_index = i);
  await saveSegments();
  renderScript(S.currentScriptData);
}

async function saveSegments() {
  if (!S.currentScript || !S.currentScriptData) return;
  try {
    await apiPost(`/script/${S.currentScript}/update-segments`, {
      segments: S.currentScriptData.segments.map((s, i) => ({
        clip_id: s.clip_id, start_time: s.start_time, end_time: s.end_time,
        section_name: s.section_name, order_index: i, notes: s.notes || '', transition: s.transition || 'cut'
      }))
    });
  } catch(e) {}
}

async function deleteScript() {
  if (!S.currentScript) return;
  if (!confirm('Delete this script?')) return;
  await api(`/script/${S.currentScript}`, {method:'DELETE'});
  toast('Script deleted', 'info');
  renderScriptEmpty();
  loadScriptsList();
}

async function duplicateScript() {
  if (!S.currentScriptData) return;
  const script = S.currentScriptData.script;
  const res = await apiPost('/scripts', { name: script.name + ' (copy)', description: script.description, target_duration: script.target_duration_seconds });
  if (res.id) {
    await apiPost(`/script/${res.id}/update-segments`, {
      segments: S.currentScriptData.segments.map((s, i) => ({
        clip_id: s.clip_id, start_time: s.start_time, end_time: s.end_time,
        section_name: s.section_name, order_index: i, notes: s.notes || '', transition: s.transition || 'cut'
      }))
    });
    toast('Script duplicated', 'success');
    await loadScriptsList();
    $('#scriptSelect').value = res.id;
    loadScript(res.id);
  }
}

// ‚îÄ‚îÄ TIMELINE TAB ‚îÄ‚îÄ
function openInTimeline() {
  if (!S.currentScriptData) return;
  S.timelineScript = S.currentScriptData;
  S.timelineSegmentIndex = 0;
  switchTab('timeline');
}

function renderTimeline() {
  const data = S.timelineScript;
  if (!data) {
    $('#timelineScriptPanel').innerHTML = '<div style="padding:40px;color:var(--text3);text-align:center">No script loaded. Go to Scripts tab first.</div>';
    $('#filmstrip').innerHTML = '';
    return;
  }
  const script = data.script;
  const segments = data.segments || [];
  const totalDur = segments.reduce((a, s) => a + ((s.end_time||0) - (s.start_time||0)), 0);

  $('#timelineTitle').textContent = script.name;
  $('#timelineDuration').textContent = fmtDurLong(totalDur);

  // Script panel
  let lastSection = '';
  let html = '';
  segments.forEach((seg, i) => {
    if (seg.section_name && seg.section_name !== lastSection) {
      html += `<div class="tl-section-header">${escHtml(seg.section_name)}</div>`;
      lastSection = seg.section_name;
    }
    html += `
      <div class="tl-segment ${i === S.timelineSegmentIndex ? 'active' : ''}" onclick="selectTimelineSegment(${i})">
        <img class="tl-segment-thumb" src="/api/thumbnails/${seg.clip_id}" onerror="this.style.background='var(--surface2)'">
        <div class="tl-segment-content">
          <div class="tl-segment-speaker">${escHtml(seg.filename || '')}</div>
          <div class="tl-segment-text">${escHtml(seg.transcript_text || seg.notes || '‚Ä¶')}</div>
        </div>
        <div class="tl-segment-tc">${fmtDur(seg.start_time)}</div>
      </div>
    `;
  });
  $('#timelineScriptPanel').innerHTML = html;

  // Filmstrip
  const maxDur = Math.max(...segments.map(s => (s.end_time||0)-(s.start_time||0)), 1);
  $('#filmstrip').innerHTML = segments.map((seg, i) => {
    const dur = (seg.end_time||0) - (seg.start_time||0);
    const w = Math.max(80, Math.round((dur / maxDur) * 200));
    return `
      <div class="filmstrip-block ${i === S.timelineSegmentIndex ? 'active' : ''}" style="min-width:${w}px;border-left:3px solid ${clipColor(seg.clip_id)}" onclick="selectTimelineSegment(${i})">
        <img class="filmstrip-thumb" src="/api/thumbnails/${seg.clip_id}" onerror="this.style.background='var(--bg)'">
        <div class="filmstrip-text">${escHtml((seg.transcript_text || seg.notes || '').slice(0,30))}</div>
        <div class="filmstrip-dur">${fmtDur(dur)}</div>
      </div>
    `;
  }).join('') + `<div class="filmstrip-total">${fmtDurLong(totalDur)}</div>`;

  // Preview
  if (segments.length) selectTimelineSegment(S.timelineSegmentIndex);
}

function selectTimelineSegment(idx) {
  const data = S.timelineScript;
  if (!data || !data.segments) return;
  S.timelineSegmentIndex = idx;
  const seg = data.segments[idx];
  if (!seg) return;

  // Update active states
  $$('.tl-segment').forEach((el, i) => el.classList.toggle('active', i === idx));
  $$('.filmstrip-block').forEach((el, i) => el.classList.toggle('active', i === idx));

  // Scroll active segment into view
  const activeEl = $$('.tl-segment')[idx];
  if (activeEl) activeEl.scrollIntoView({behavior:'smooth', block:'nearest'});
  const activeFilm = $$('.filmstrip-block')[idx];
  if (activeFilm) activeFilm.scrollIntoView({behavior:'smooth', block:'nearest', inline:'center'});

  // Preview
  $('#previewFrame').innerHTML = `<img src="/api/thumbnails/${seg.clip_id}" onerror="this.parentElement.innerHTML='<div class=preview-placeholder>No thumbnail</div>'">`;
  $('#previewInfo').innerHTML = `
    <div class="preview-clip-name">${escHtml(seg.filename || '‚Äî')}</div>
    <div class="preview-clip-tc">${fmtDur(seg.start_time)} ‚Üí ${fmtDur(seg.end_time)}</div>
  `;
  const dur = (seg.end_time||0) - (seg.start_time||0);
  $('#previewSegmentInfo').textContent = `${seg.section_name || ''} ¬∑ ${fmtDurLong(dur)} ¬∑ Segment ${idx+1} of ${data.segments.length}`;
}

function prevSegment() {
  if (S.timelineSegmentIndex > 0) selectTimelineSegment(S.timelineSegmentIndex - 1);
}
function nextSegment() {
  const segs = S.timelineScript?.segments;
  if (segs && S.timelineSegmentIndex < segs.length - 1) selectTimelineSegment(S.timelineSegmentIndex + 1);
}

async function sendToResolve() {
  if (!S.timelineScript) return;
  const btn = event.target;
  btn.disabled = true; btn.textContent = 'Sending‚Ä¶';
  try {
    const res = await apiPost(`/export/resolve/${S.timelineScript.script.id}`, {});
    if (res.error) { toast(res.error, 'error'); }
    else toast(`Timeline "${res.timeline_name}" created ‚Äî ${res.segments_added} segments`, 'success');
  } catch(e) { toast('Export failed: ' + e.message, 'error'); }
  finally { btn.disabled = false; btn.textContent = 'üé¨ Send to Resolve'; }
}

async function exportEDL() {
  if (!S.timelineScript) return;
  try {
    const r = await fetch(`/api/export/edl/${S.timelineScript.script.id}`, {method:'POST'});
    const blob = await r.blob();
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `script_${S.timelineScript.script.id}.edl`;
    a.click();
    toast('EDL downloaded', 'success');
  } catch(e) { toast('EDL export failed', 'error'); }
}

// ‚îÄ‚îÄ Actions ‚îÄ‚îÄ
async function doIngest() {
  toast('Rescanning‚Ä¶', 'info');
  await apiPost('/ingest', {});
  await loadAll();
  toast('Rescan complete', 'success');
}

async function doTranscribe() {
  const btn = $('#transcribeBtn');
  btn.disabled = true; btn.innerHTML = '<span class="spinner"></span> Starting‚Ä¶';
  try {
    const res = await apiPost('/transcribe', {method: 'whisper'});
    toast(`Transcription started (${res.method})`, 'info');
    pollTranscription();
  } catch(e) { toast('Transcription failed: ' + e.message, 'error'); btn.disabled = false; btn.textContent = 'Transcribe All'; }
}

function pollTranscription() {
  const poll = async () => {
    try {
      const p = await api('/transcribe/progress');
      const btn = $('#transcribeBtn');
      if (p.running) {
        btn.innerHTML = `<span class="spinner"></span> ${p.done}/${p.total} ${p.current||''}`;
        setTimeout(poll, 2000);
      } else {
        btn.disabled = false; btn.textContent = 'Transcribe All';
        await loadAll();
        toast('Transcription complete', 'success');
      }
    } catch(e) { setTimeout(poll, 3000); }
  };
  setTimeout(poll, 2000);
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
loadAll();

// Also load transcript text for script segments (the API may not include it)
// We'll enrich script data with transcript text when loading scripts
const _origLoadScript = loadScript;
loadScript = async function(id) {
  if (!id) { renderScriptEmpty(); return; }
  try {
    const data = await api(`/script/${id}`);
    // Enrich segments with transcript text
    for (const seg of (data.segments || [])) {
      if (!seg.transcript_text && seg.clip_id) {
        try {
          if (!S.transcripts[seg.clip_id]) {
            S.transcripts[seg.clip_id] = await api(`/transcript/${seg.clip_id}`);
          }
          const t = S.transcripts[seg.clip_id];
          if (t && t.segments) {
            const matching = t.segments.filter(ts =>
              ts.start >= (seg.start_time - 0.5) && ts.end <= (seg.end_time + 0.5)
            );
            seg.transcript_text = matching.map(m => m.text).join(' ') || '';
          }
        } catch(e) {}
      }
    }
    S.currentScript = id;
    S.currentScriptData = data;
    renderScript(data);
  } catch(e) { toast('Failed to load script', 'error'); }
};
</script>
</body>
</html>
