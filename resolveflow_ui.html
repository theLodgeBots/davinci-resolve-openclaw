<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ResolveFlow</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#1a1a2e;--surface:#16213e;--surface2:#1c2a4a;--surface3:#223052;--accent:#e94560;--accent2:#0f3460;--text:#eee;--text2:#aaa;--green:#4ade80;--green-dark:#16a34a;--border:#2a3a5e;--radius:8px;--transition:0.2s ease}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:flex;flex-direction:column}
button{cursor:pointer;font-family:inherit;border:none;border-radius:var(--radius);transition:all var(--transition)}
button:hover{filter:brightness(1.15)}
input,select,textarea{font-family:inherit;background:var(--surface);color:var(--text);border:1px solid var(--border);border-radius:var(--radius);padding:8px 12px;outline:none;transition:border var(--transition)}
input:focus,select:focus,textarea:focus{border-color:var(--accent)}
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:var(--surface)}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}

/* Header */
.header{display:flex;align-items:center;justify-content:space-between;padding:12px 20px;background:var(--surface);border-bottom:1px solid var(--border);flex-shrink:0;gap:12px;flex-wrap:wrap}
.header-left{display:flex;align-items:center;gap:16px}
.logo{font-size:20px;font-weight:700;color:var(--accent);letter-spacing:-0.5px}
.project-name{color:var(--text2);font-size:14px}
.header-stats{display:flex;align-items:center;gap:16px;font-size:13px;color:var(--text2)}
.resolve-status{display:flex;align-items:center;gap:6px}
.status-dot{width:8px;height:8px;border-radius:50%;background:#666;flex-shrink:0}
.status-dot.connected{background:var(--green)}
.status-dot.disconnected{background:var(--accent)}

/* Tabs */
.tab-bar{display:flex;background:var(--surface);border-bottom:1px solid var(--border);flex-shrink:0}
.tab{flex:1;padding:14px 20px;text-align:center;font-size:15px;font-weight:600;color:var(--text2);background:transparent;border-radius:0;border-bottom:3px solid transparent;transition:all var(--transition)}
.tab.active{color:var(--text);border-bottom-color:var(--accent)}
.tab:hover{color:var(--text);background:rgba(233,69,96,0.05)}

/* Main content */
.tab-content{flex:1;overflow:hidden;display:none}
.tab-content.active{display:flex;flex-direction:column}

/* ===== CLIPS TAB ===== */
.clips-toolbar{display:flex;align-items:center;gap:12px;padding:12px 20px;flex-shrink:0;flex-wrap:wrap}
.search-input{flex:1;min-width:200px;padding:10px 14px;font-size:14px}
.btn{padding:10px 18px;font-size:13px;font-weight:600;border-radius:var(--radius)}
.btn-accent{background:var(--accent);color:#fff}
.btn-green{background:var(--green-dark);color:#fff}
.btn-secondary{background:var(--surface2);color:var(--text2);border:1px solid var(--border)}
.btn-danger{background:#dc2626;color:#fff}
.btn-small{padding:6px 12px;font-size:12px}

.clips-grid{flex:1;overflow-y:auto;padding:12px 20px;display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:12px;align-content:start}
.clip-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;cursor:pointer;transition:all var(--transition)}
.clip-card:hover{border-color:var(--accent);transform:translateY(-1px)}
.clip-card.expanded{grid-column:1/-1}
.clip-top{display:flex;gap:12px;padding:12px}
.clip-thumb{width:120px;height:68px;background:var(--surface2);border-radius:4px;flex-shrink:0;display:flex;align-items:center;justify-content:center;color:var(--text2);font-size:11px;overflow:hidden}
.clip-thumb img{width:100%;height:100%;object-fit:cover}
.clip-info{flex:1;min-width:0}
.clip-filename{font-size:14px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.clip-meta{display:flex;gap:8px;margin-top:4px;font-size:12px;color:var(--text2);flex-wrap:wrap}
.clip-badge{padding:2px 6px;border-radius:3px;background:var(--accent2);font-size:11px;color:var(--text)}
.clip-badge.transcribed{background:var(--green-dark)}
.clip-badge.pending{background:#92400e}
.clip-preview{padding:0 12px 8px;font-size:12px;color:var(--text2);line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.clip-transcript{padding:12px;border-top:1px solid var(--border);max-height:300px;overflow-y:auto;display:none}
.clip-card.expanded .clip-transcript{display:block}
.transcript-line{font-size:13px;line-height:1.6;padding:2px 0}
.transcript-line .tc{color:var(--accent);font-size:11px;margin-right:6px;font-family:'SF Mono',monospace}

/* ===== SCRIPTS TAB ===== */
.scripts-container{flex:1;display:flex;flex-direction:column;overflow:hidden}
.script-selector{display:flex;align-items:center;gap:12px;padding:12px 20px;border-bottom:1px solid var(--border);flex-wrap:wrap;flex-shrink:0}
.script-selector select{min-width:200px;padding:10px 12px}
.script-meta{font-size:12px;color:var(--text2);display:flex;gap:12px;align-items:center}

.scripts-main{flex:1;display:flex;overflow:hidden}
.transcript-panel,.script-panel{flex:1;display:flex;flex-direction:column;overflow:hidden}
.transcript-panel{border-right:1px solid var(--border)}
.panel-header{display:flex;align-items:center;gap:8px;padding:10px 16px;border-bottom:1px solid var(--border);flex-wrap:wrap;flex-shrink:0}
.panel-title{font-size:14px;font-weight:600;margin-right:auto}
.transcript-search{padding:8px 12px;font-size:13px;width:180px}
.panel-body{flex:1;overflow-y:auto;padding:12px 16px}

/* Transcript */
.transcript-clip-section{margin-bottom:16px}
.transcript-clip-header{font-size:13px;font-weight:700;color:var(--accent);padding:6px 0;border-bottom:1px solid var(--border);margin-bottom:4px;position:sticky;top:0;background:var(--bg);z-index:1}
.transcript-segment{padding:4px 8px;border-radius:4px;cursor:pointer;transition:background var(--transition);font-size:13px;line-height:1.5}
.transcript-segment:hover{background:var(--surface2)}
.transcript-segment .tc{color:var(--accent);font-size:11px;margin-right:6px;font-family:'SF Mono',monospace}
.transcript-segment.highlight{background:rgba(233,69,96,0.2)}

/* Script editor */
.script-segments{list-style:none}
.segment-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:10px 12px;margin-bottom:8px;transition:all var(--transition)}
.segment-card:hover{border-color:var(--accent)}
.segment-top{display:flex;align-items:center;gap:8px}
.segment-name{flex:1;background:transparent;border:none;color:var(--text);font-size:14px;font-weight:600;padding:2px 4px;border-radius:4px}
.segment-name:focus{background:var(--surface2);outline:1px solid var(--accent)}
.segment-actions{display:flex;gap:4px}
.segment-actions button{width:28px;height:28px;display:flex;align-items:center;justify-content:center;background:var(--surface2);color:var(--text2);font-size:14px;border-radius:4px;padding:0}
.segment-actions button:hover{color:var(--text)}
.segment-clip{font-size:12px;color:var(--text2);margin-top:4px}
.segment-text{font-size:12px;color:var(--text2);margin-top:4px;line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.script-footer{padding:12px 16px;border-top:1px solid var(--border);display:flex;align-items:center;gap:12px;flex-wrap:wrap;flex-shrink:0}
.script-duration{font-size:14px;font-weight:600;margin-right:auto}
.empty-state{text-align:center;padding:40px 20px;color:var(--text2);font-size:14px}

/* Modal */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:100;align-items:center;justify-content:center}
.modal-overlay.active{display:flex}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:24px;width:90%;max-width:440px}
.modal h3{margin-bottom:16px;font-size:18px}
.modal label{display:block;font-size:13px;color:var(--text2);margin-bottom:4px;margin-top:12px}
.modal select,.modal input,.modal textarea{width:100%}
.modal textarea{height:80px;resize:vertical}
.modal-actions{display:flex;gap:8px;margin-top:20px;justify-content:flex-end}

/* Toast */
.toast{position:fixed;bottom:20px;right:20px;background:var(--surface2);border:1px solid var(--border);padding:12px 20px;border-radius:var(--radius);font-size:14px;z-index:200;transform:translateY(80px);opacity:0;transition:all 0.3s ease}
.toast.show{transform:translateY(0);opacity:1}
.toast.error{border-color:var(--accent)}
.toast.success{border-color:var(--green)}

/* Responsive */
@media(max-width:768px){
  .scripts-main{flex-direction:column}
  .transcript-panel{border-right:none;border-bottom:1px solid var(--border);max-height:45vh}
  .clips-grid{grid-template-columns:1fr}
  .header{padding:10px 14px}
  .header-stats{font-size:12px}
}
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div class="header-left">
    <div class="logo">ResolveFlow</div>
    <div class="project-name" id="projectName">Loading...</div>
  </div>
  <div class="header-stats">
    <span id="clipCount">0 clips</span>
    <span id="totalDuration">0:00</span>
    <div class="resolve-status">
      <div class="status-dot" id="statusDot"></div>
      <span id="statusText">Checking...</span>
    </div>
  </div>
</div>

<!-- Tab Bar -->
<div class="tab-bar">
  <button class="tab active" data-tab="clips">Clips</button>
  <button class="tab" data-tab="scripts">Scripts</button>
</div>

<!-- Clips Tab -->
<div class="tab-content active" id="tab-clips">
  <!-- Summary Stats Bar -->
  <div class="clips-stats" id="clipsStats" style="display:flex;align-items:center;gap:20px;padding:14px 20px;background:var(--surface);border-bottom:1px solid var(--border);flex-wrap:wrap;font-size:13px;color:var(--text2)">
  </div>
  <!-- Filter/Sort Controls -->
  <div class="clips-filters" style="display:flex;align-items:center;gap:10px;padding:10px 20px;flex-wrap:wrap;font-size:13px;border-bottom:1px solid var(--border)">
    <span style="color:var(--text2);font-weight:600">Device:</span>
    <div id="deviceFilters" style="display:flex;gap:4px"></div>
    <span style="color:var(--text2);font-weight:600;margin-left:12px">Status:</span>
    <div id="statusFilters" style="display:flex;gap:4px"></div>
    <span style="color:var(--text2);font-weight:600;margin-left:12px">Sort:</span>
    <select id="sortSelect" style="padding:4px 8px;font-size:12px;background:var(--surface2);color:var(--text);border:1px solid var(--border);border-radius:4px">
      <option value="name">Name</option>
      <option value="duration">Duration</option>
      <option value="device">Device</option>
    </select>
  </div>
  <div class="clips-toolbar">
    <input type="text" class="search-input" id="clipSearch" placeholder="Search clips...">
    <button class="btn btn-accent" id="transcribeAllBtn">Transcribe All</button>
  </div>
  <div class="clips-grid" id="clipsGrid"></div>
</div>

<!-- Scripts Tab -->
<div class="tab-content" id="tab-scripts">
  <div class="scripts-container">
    <div class="script-selector">
      <select id="scriptSelect"><option value="">Select a script...</option></select>
      <button class="btn btn-accent btn-small" id="newScriptBtn">+ New Script</button>
      <button class="btn btn-danger btn-small" id="deleteScriptBtn" style="display:none">Delete</button>
      <div class="script-meta" id="scriptMeta"></div>
    </div>
    <div class="scripts-main">
      <!-- Left: Transcript -->
      <div class="transcript-panel">
        <div class="panel-header">
          <div class="panel-title">Full Transcript</div>
          <input type="text" class="transcript-search" id="transcriptSearch" placeholder="Search...">
          <button class="btn btn-secondary btn-small" id="addAllBtn">Add All</button>
          <button class="btn btn-accent btn-small" id="aiGenerateBtn">AI Generate</button>
        </div>
        <div class="panel-body" id="transcriptBody">
          <div class="empty-state">Transcripts will appear here after transcription.</div>
        </div>
      </div>
      <!-- Right: Script Editor -->
      <div class="script-panel">
        <div class="panel-header">
          <div class="panel-title">Script Editor</div>
        </div>
        <div class="panel-body" id="scriptBody">
          <div class="empty-state" id="scriptEmpty">Select or create a script to begin editing.</div>
          <ul class="script-segments" id="scriptSegments"></ul>
        </div>
        <div class="script-footer">
          <div class="script-duration" id="scriptDuration">0:00</div>
          <button class="btn btn-secondary" id="exportEdlBtn">Export EDL</button>
          <button class="btn btn-green" id="sendResolveBtn" style="padding:12px 24px;font-size:15px">Send to Resolve</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- AI Modal -->
<div class="modal-overlay" id="aiModal">
  <div class="modal">
    <h3>AI Generate Script</h3>
    <label>Target Duration</label>
    <select id="aiDuration">
      <option value="30">30 seconds</option>
      <option value="60" selected>1 minute</option>
      <option value="120">2 minutes</option>
      <option value="300">5 minutes</option>
      <option value="custom">Custom...</option>
    </select>
    <input type="number" id="aiCustomDuration" placeholder="Seconds" style="display:none;margin-top:8px">
    <label>Style</label>
    <select id="aiStyle">
      <option value="highlight">Highlight Reel</option>
      <option value="documentary">Documentary</option>
      <option value="interview">Interview</option>
      <option value="social">Social Media</option>
    </select>
    <label>Custom Prompt (optional)</label>
    <textarea id="aiPrompt" placeholder="e.g. Focus on the outdoor shots, upbeat energy..."></textarea>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      <button class="btn btn-accent" id="aiSubmitBtn">Generate</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// State
let clips = [];
let scripts = [];
let currentScript = null;
let fullTranscript = [];
let expandedClip = null;
let activeDeviceFilter = 'All';
let activeStatusFilter = 'All';
let activeSort = 'name';

// Helpers
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);

function toast(msg, type='') {
  const t = $('#toast');
  t.textContent = msg;
  t.className = 'toast show ' + type;
  setTimeout(() => t.className = 'toast', 3000);
}

function formatTime(sec) {
  if (!sec && sec !== 0) return '0:00';
  const m = Math.floor(sec / 60);
  const s = Math.floor(sec % 60);
  return `${m}:${s.toString().padStart(2,'0')}`;
}

function formatTC(sec) {
  const m = Math.floor(sec / 60);
  const s = (sec % 60).toFixed(1);
  return `${m.toString().padStart(2,'0')}:${s.padStart(4,'0')}`;
}

async function api(url, opts={}) {
  try {
    const r = await fetch(url, {headers:{'Content-Type':'application/json'}, ...opts});
    if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
    return await r.json();
  } catch(e) {
    console.error('API error:', url, e);
    throw e;
  }
}

// Tabs
$$('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    $$('.tab').forEach(t => t.classList.remove('active'));
    $$('.tab-content').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    $(`#tab-${tab.dataset.tab}`).classList.add('active');
    if (tab.dataset.tab === 'scripts') loadFullTranscript();
  });
});

// Check Resolve status
async function checkStatus() {
  try {
    const d = await api('/api/resolve/status');
    const dot = $('#statusDot');
    const txt = $('#statusText');
    if (d.connected) {
      dot.className = 'status-dot connected';
      txt.textContent = 'Resolve Connected';
      if (d.project) $('#projectName').textContent = d.project;
    } else {
      dot.className = 'status-dot disconnected';
      txt.textContent = 'Disconnected';
    }
  } catch {
    $('#statusDot').className = 'status-dot disconnected';
    $('#statusText').textContent = 'Offline';
  }
}

// Load clips
async function loadClips() {
  try {
    const d = await api('/api/clips');
    clips = d.clips || d || [];
    renderStats();
    renderFilterChips();
    renderClips();
    const total = clips.reduce((a,c) => a + (c.duration_seconds||0), 0);
    $('#clipCount').textContent = `${clips.length} clips`;
    $('#totalDuration').textContent = formatTime(total);
  } catch(e) {
    toast('Failed to load clips', 'error');
  }
}

function renderStats() {
  const total = clips.length;
  const totalDur = clips.reduce((a,c) => a + (c.duration_seconds||0), 0);
  const devices = {};
  clips.forEach(c => { const d = c.camera || 'Unknown'; devices[d] = (devices[d]||0) + 1; });
  const transcribed = clips.filter(c => c.has_transcript).length;
  const deviceParts = Object.entries(devices).map(([k,v]) =>
    `<span class="filter-chip${activeDeviceFilter===k?' active':''}" onclick="setDeviceFilter('${k}')" style="cursor:pointer;padding:2px 8px;border-radius:12px;background:${activeDeviceFilter===k?'var(--accent)':'var(--surface2)'};color:var(--text);font-size:12px">${k} (${v})</span>`
  ).join(' ');
  $('#clipsStats').innerHTML = `
    <span><strong>${total}</strong> clips</span>
    <span><strong>${formatTime(totalDur)}</strong> total</span>
    <span>Devices: ${deviceParts}</span>
    <span>Transcribed: <strong>${transcribed}/${total}</strong></span>
  `;
}

function renderFilterChips() {
  const devices = ['All', ...new Set(clips.map(c => c.camera || 'Unknown'))];
  $('#deviceFilters').innerHTML = devices.map(d =>
    `<button onclick="setDeviceFilter('${d}')" style="padding:3px 10px;border-radius:12px;border:1px solid var(--border);background:${activeDeviceFilter===d?'var(--accent)':'var(--surface2)'};color:var(--text);font-size:12px;cursor:pointer">${d}</button>`
  ).join('');
  const statuses = ['All','Transcribed','Pending'];
  $('#statusFilters').innerHTML = statuses.map(s =>
    `<button onclick="setStatusFilter('${s}')" style="padding:3px 10px;border-radius:12px;border:1px solid var(--border);background:${activeStatusFilter===s?'var(--accent)':'var(--surface2)'};color:var(--text);font-size:12px;cursor:pointer">${s}</button>`
  ).join('');
}

function setDeviceFilter(d) { activeDeviceFilter = d; renderFilterChips(); renderStats(); renderClips(); }
function setStatusFilter(s) { activeStatusFilter = s; renderFilterChips(); renderClips(); }

function getFilteredClips(searchFilter) {
  let result = clips;
  const f = (searchFilter||'').toLowerCase();
  if (f) result = result.filter(c => (c.filename||'').toLowerCase().includes(f));
  if (activeDeviceFilter !== 'All') result = result.filter(c => (c.camera||'Unknown') === activeDeviceFilter);
  if (activeStatusFilter === 'Transcribed') result = result.filter(c => c.has_transcript);
  if (activeStatusFilter === 'Pending') result = result.filter(c => !c.has_transcript);
  // Sort
  const sort = $('#sortSelect').value || activeSort;
  result = [...result].sort((a,b) => {
    if (sort === 'duration') return (b.duration_seconds||0) - (a.duration_seconds||0);
    if (sort === 'device') return (a.camera||'').localeCompare(b.camera||'');
    return (a.filename||'').localeCompare(b.filename||'');
  });
  return result;
}

function renderClips(filter) {
  if (filter === undefined) filter = $('#clipSearch').value || '';
  const grid = $('#clipsGrid');
  const filtered = getFilteredClips(filter);
  if (!filtered.length) {
    grid.innerHTML = '<div class="empty-state">No clips found.</div>';
    return;
  }
  grid.innerHTML = filtered.map(c => {
    const name = c.filename || 'Untitled';
    const dur = formatTime(c.duration_seconds);
    const cam = c.camera || 'Unknown';
    const hasTranscript = c.has_transcript || c.resolve_transcription_status === 'Transcribed';
    const preview = c.transcript_preview || '';
    const expanded = expandedClip === c.id;
    const camColor = cam === 'Sony' ? '#3b82f6' : cam === 'DJI' ? '#22c55e' : '#6b7280';
    return `<div class="clip-card${expanded?' expanded':''}" data-id="${c.id}" onclick="toggleClip('${c.id}')">
      <div class="clip-top">
        <div class="clip-thumb"><img src="/api/thumbnails/${c.id}" alt="" onerror="this.parentElement.innerHTML='üé¨'"></div>
        <div class="clip-info">
          <div class="clip-filename" title="${name}">${escHtml(name)}</div>
          <div class="clip-meta">
            <span>${dur}</span>
            <span class="clip-badge" style="background:${camColor}">${cam}</span>
            <span class="clip-badge ${hasTranscript?'transcribed':'pending'}">${hasTranscript?'‚úì Transcribed':'‚è≥ Pending'}</span>
          </div>
        </div>
      </div>
      ${preview ? `<div class="clip-preview">${escHtml(preview)}</div>` : ''}
      <div class="clip-transcript" id="transcript-${c.id}"></div>
    </div>`;
  }).join('');
}

function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

async function toggleClip(id) {
  if (expandedClip === id) { expandedClip = null; renderClips($('#clipSearch').value); return; }
  expandedClip = id;
  renderClips($('#clipSearch').value);
  const el = $(`#transcript-${id}`);
  if (!el) return;
  el.innerHTML = '<div style="padding:8px;color:var(--text2)">Loading transcript...</div>';
  try {
    const d = await api(`/api/transcript/${id}`);
    const lines = d.lines || d.segments || [];
    if (!lines.length) { el.innerHTML = '<div style="padding:8px;color:var(--text2)">No transcript available.</div>'; return; }
    el.innerHTML = lines.map(l => `<div class="transcript-line"><span class="tc">[${formatTC(l.start||l.time||0)}]</span>${escHtml(l.text||l.content||'')}</div>`).join('');
  } catch {
    el.innerHTML = '<div style="padding:8px;color:var(--text2)">Failed to load transcript.</div>';
  }
}

$('#clipSearch').addEventListener('input', e => renderClips(e.target.value));
$('#sortSelect').addEventListener('change', () => renderClips());

$('#transcribeAllBtn').addEventListener('click', async () => {
  toast('Starting transcription...');
  try {
    await api('/api/transcribe', {method:'POST'});
    toast('Transcription started!', 'success');
    setTimeout(loadClips, 3000);
  } catch { toast('Transcription failed', 'error'); }
});

// Scripts
async function loadScripts() {
  try {
    const d = await api('/api/scripts');
    scripts = d.scripts || d || [];
    const sel = $('#scriptSelect');
    sel.innerHTML = '<option value="">Select a script...</option>' + scripts.map(s => `<option value="${s.id}">${escHtml(s.name||'Untitled')}</option>`).join('');
  } catch {}
}

$('#scriptSelect').addEventListener('change', async e => {
  const id = e.target.value;
  if (!id) { currentScript = null; renderScript(); return; }
  try {
    currentScript = await api(`/api/script/${id}`);
    renderScript();
  } catch { toast('Failed to load script', 'error'); }
});

$('#newScriptBtn').addEventListener('click', async () => {
  const name = prompt('Script name:');
  if (!name) return;
  const dur = prompt('Target duration (seconds):', '120');
  try {
    const s = await api('/api/scripts', {method:'POST', body: JSON.stringify({name, target_duration: parseInt(dur)||120})});
    toast('Script created!', 'success');
    await loadScripts();
    if (s.id) { $('#scriptSelect').value = s.id; currentScript = s; renderScript(); }
  } catch { toast('Failed to create script', 'error'); }
});

$('#deleteScriptBtn').addEventListener('click', async () => {
  if (!currentScript || !confirm('Delete this script?')) return;
  try {
    await api(`/api/script/${currentScript.id}`, {method:'DELETE'});
    currentScript = null;
    toast('Script deleted', 'success');
    await loadScripts();
    renderScript();
  } catch { toast('Failed to delete', 'error'); }
});

function renderScript() {
  const del = $('#deleteScriptBtn');
  const meta = $('#scriptMeta');
  const segs = $('#scriptSegments');
  const empty = $('#scriptEmpty');
  if (!currentScript) {
    del.style.display = 'none';
    meta.innerHTML = '';
    segs.innerHTML = '';
    empty.style.display = 'block';
    $('#scriptDuration').textContent = '0:00';
    return;
  }
  del.style.display = '';
  meta.innerHTML = `<span>${currentScript.target_duration ? 'Target: '+formatTime(currentScript.target_duration) : ''}</span><span>${currentScript.created_at ? new Date(currentScript.created_at).toLocaleDateString() : ''}</span>`;
  empty.style.display = 'none';
  const segments = currentScript.segments || [];
  if (!segments.length) {
    segs.innerHTML = '<div class="empty-state">No segments yet. Add from transcript or use AI Generate.</div>';
    $('#scriptDuration').textContent = '0:00';
    return;
  }
  let totalDur = 0;
  segs.innerHTML = segments.map((s, i) => {
    const dur = (s.end_time||0) - (s.start_time||0);
    totalDur += dur;
    return `<li class="segment-card" data-id="${s.id}">
      <div class="segment-top">
        <input class="segment-name" value="${escHtml(s.section_name||'Segment '+(i+1))}" onchange="updateSegment('${s.id}',this.value)">
        <div class="segment-actions">
          ${i>0?`<button onclick="moveSegment(${i},-1)" title="Move up">‚Üë</button>`:'<button disabled>‚Üë</button>'}
          ${i<segments.length-1?`<button onclick="moveSegment(${i},1)" title="Move down">‚Üì</button>`:'<button disabled>‚Üì</button>'}
          <button onclick="removeSegment('${s.id}')" title="Remove" style="color:var(--accent)">‚úï</button>
        </div>
      </div>
      <div class="segment-clip">${escHtml(s.clip_name||s.clip_id||'')} [${formatTC(s.start_time||0)} ‚Üí ${formatTC(s.end_time||0)}]</div>
      ${s.text?`<div class="segment-text">${escHtml(s.text)}</div>`:''}
    </li>`;
  }).join('');
  $('#scriptDuration').textContent = formatTime(totalDur);
}

async function updateSegment(segId, name) {
  if (!currentScript) return;
  try {
    await api(`/api/script/${currentScript.id}/segment/${segId}`, {method:'PUT', body: JSON.stringify({section_name:name})});
  } catch { toast('Update failed', 'error'); }
}

async function removeSegment(segId) {
  if (!currentScript) return;
  try {
    await api(`/api/script/${currentScript.id}/segment/${segId}`, {method:'DELETE'});
    currentScript.segments = (currentScript.segments||[]).filter(s=>s.id!==segId);
    renderScript();
    toast('Segment removed', 'success');
  } catch { toast('Remove failed', 'error'); }
}

async function moveSegment(idx, dir) {
  if (!currentScript) return;
  const segs = currentScript.segments||[];
  const newIdx = idx+dir;
  if (newIdx<0||newIdx>=segs.length) return;
  [segs[idx],segs[newIdx]]=[segs[newIdx],segs[idx]];
  renderScript();
  // Persist reorder by updating both segments
  try {
    await api(`/api/script/${currentScript.id}/segment/${segs[idx].id}`, {method:'PUT', body: JSON.stringify({order:idx})});
    await api(`/api/script/${currentScript.id}/segment/${segs[newIdx].id}`, {method:'PUT', body: JSON.stringify({order:newIdx})});
  } catch {}
}

// Full transcript
async function loadFullTranscript() {
  try {
    const d = await api('/api/transcript/full');
    fullTranscript = d.clips || d.sections || d || [];
    renderTranscript();
  } catch {
    $('#transcriptBody').innerHTML = '<div class="empty-state">No transcripts available. Transcribe clips first.</div>';
  }
}

function renderTranscript(filter='') {
  const body = $('#transcriptBody');
  const f = filter.toLowerCase();
  let html = '';
  const data = Array.isArray(fullTranscript) ? fullTranscript : [];
  if (!data.length) { body.innerHTML = '<div class="empty-state">No transcripts available.</div>'; return; }
  data.forEach(clip => {
    const lines = clip.lines || clip.segments || [];
    const filteredLines = f ? lines.filter(l=>(l.text||l.content||'').toLowerCase().includes(f)) : lines;
    if (f && !filteredLines.length) return;
    html += `<div class="transcript-clip-section"><div class="transcript-clip-header">${escHtml(clip.filename||clip.name||clip.clip_id||'')}</div>`;
    filteredLines.forEach(l => {
      const text = l.text||l.content||'';
      const highlighted = f ? text.replace(new RegExp(`(${f.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`,'gi'),'<mark style="background:var(--accent);color:#fff;border-radius:2px;padding:0 2px">$1</mark>') : escHtml(text);
      html += `<div class="transcript-segment${f && text.toLowerCase().includes(f)?' highlight':''}" onclick="addSegmentFromTranscript('${clip.clip_id||clip.id||''}',${l.start||l.time||0},${l.end||(l.start||0)+5},'${escHtml(text).replace(/'/g,"\\'")}')"><span class="tc">[${formatTC(l.start||l.time||0)}]</span>${highlighted}</div>`;
    });
    html += '</div>';
  });
  body.innerHTML = html || '<div class="empty-state">No matches found.</div>';
}

$('#transcriptSearch').addEventListener('input', e => renderTranscript(e.target.value));

async function addSegmentFromTranscript(clipId, start, end, text) {
  if (!currentScript) { toast('Select or create a script first'); return; }
  try {
    const seg = await api(`/api/script/${currentScript.id}/segments`, {method:'POST', body: JSON.stringify({clip_id:clipId, start_time:start, end_time:end, section_name:'Segment'})});
    if (!currentScript.segments) currentScript.segments = [];
    currentScript.segments.push({...seg, text, clip_id:clipId, start_time:start, end_time:end});
    renderScript();
    toast('Segment added', 'success');
  } catch { toast('Failed to add segment', 'error'); }
}

$('#addAllBtn').addEventListener('click', async () => {
  if (!currentScript) { toast('Select or create a script first'); return; }
  if (!fullTranscript.length) return;
  toast('Adding all segments...');
  for (const clip of fullTranscript) {
    const lines = clip.lines || clip.segments || [];
    for (const l of lines) {
      try {
        await api(`/api/script/${currentScript.id}/segments`, {method:'POST', body: JSON.stringify({clip_id:clip.clip_id||clip.id, start_time:l.start||l.time||0, end_time:l.end||(l.start||0)+5, section_name:'Segment'})});
      } catch {}
    }
  }
  // Reload script
  try { currentScript = await api(`/api/script/${currentScript.id}`); renderScript(); } catch {}
  toast('All segments added!', 'success');
});

// AI Modal
$('#aiGenerateBtn').addEventListener('click', () => {
  if (!currentScript) { toast('Select or create a script first'); return; }
  $('#aiModal').classList.add('active');
});
function closeModal() { $('#aiModal').classList.remove('active'); }
$('#aiModal').addEventListener('click', e => { if (e.target === $('#aiModal')) closeModal(); });
$('#aiDuration').addEventListener('change', e => {
  $('#aiCustomDuration').style.display = e.target.value==='custom'?'':'none';
});
$('#aiSubmitBtn').addEventListener('click', async () => {
  const durSel = $('#aiDuration').value;
  const duration = durSel==='custom' ? parseInt($('#aiCustomDuration').value)||60 : parseInt(durSel);
  const style = $('#aiStyle').value;
  const prompt = $('#aiPrompt').value;
  closeModal();
  toast('Generating script with AI...');
  try {
    const d = await api('/api/ai/auto-edit', {method:'POST', body: JSON.stringify({target_duration:duration, style, prompt, script_id:currentScript.id})});
    toast('AI script generated!', 'success');
    currentScript = await api(`/api/script/${currentScript.id}`);
    renderScript();
  } catch { toast('AI generation failed', 'error'); }
});

// Export
$('#sendResolveBtn').addEventListener('click', async () => {
  if (!currentScript) { toast('No script selected'); return; }
  toast('Sending to Resolve...');
  try {
    await api(`/api/export/resolve/${currentScript.id}`, {method:'POST'});
    toast('Timeline created in Resolve!', 'success');
  } catch { toast('Failed to send to Resolve', 'error'); }
});

$('#exportEdlBtn').addEventListener('click', async () => {
  if (!currentScript) { toast('No script selected'); return; }
  try {
    const r = await fetch(`/api/export/edl/${currentScript.id}`);
    const blob = await r.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `${currentScript.name||'script'}.edl`; a.click();
    URL.revokeObjectURL(url);
  } catch { toast('Export failed', 'error'); }
});

// Init
checkStatus();
loadClips();
loadScripts();
setInterval(checkStatus, 15000);
</script>
</body>
</html>
