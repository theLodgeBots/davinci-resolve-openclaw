<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ResolveFlow</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0f1119;--surface:#161822;--surface2:#1c1f2e;--surface3:#222639;
  --accent:#e94560;--accent2:#c73a52;--text:#eaedf3;--text2:#8892a8;--text3:#505672;
  --green:#4ade80;--green-dark:#16a34a;--orange:#f59e0b;--blue:#3b82f6;
  --border:#262a3e;--border2:#353a52;
  --radius:8px;--radius-lg:12px;--transition:0.18s ease;
  --doc-bg:#1a1d2e;
}
html,body{height:100%;overflow:hidden}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column}
button{cursor:pointer;font-family:inherit;border:none;border-radius:var(--radius);transition:all var(--transition)}
button:hover{filter:brightness(1.15)}
button:active{transform:scale(0.97)}
input,select,textarea{font-family:inherit;background:var(--surface2);color:var(--text);border:1px solid var(--border);border-radius:var(--radius);padding:8px 12px;outline:none;transition:border var(--transition)}
input:focus,select:focus,textarea:focus{border-color:var(--accent)}
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--border2)}

.btn{padding:8px 18px;font-size:13px;font-weight:600;border-radius:var(--radius);display:inline-flex;align-items:center;gap:6px}
.btn-accent{background:var(--accent);color:#fff}
.btn-green{background:var(--green-dark);color:#fff}
.btn-blue{background:var(--blue);color:#fff}
.btn-secondary{background:var(--surface2);color:var(--text2);border:1px solid var(--border)}
.btn-ghost{background:transparent;color:var(--text2);padding:6px 12px}
.btn-ghost:hover{background:var(--surface2)}
.btn-sm{padding:5px 12px;font-size:12px}
.btn-lg{padding:12px 28px;font-size:15px;border-radius:var(--radius-lg)}
.badge{display:inline-block;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:600}
.badge-sony{background:#3b82f620;color:#60a5fa}
.badge-dji{background:#f59e0b20;color:#fbbf24}
.badge-unknown{background:#64748b20;color:#94a3b8}
.badge-transcribed{background:#4ade8020;color:#4ade80}
.badge-pending{background:#f59e0b20;color:#f59e0b}

/* Header */
.header{display:flex;align-items:center;padding:0 20px;height:52px;background:var(--surface);border-bottom:1px solid var(--border);gap:16px;flex-shrink:0;z-index:100}
.logo{font-size:18px;font-weight:800;color:var(--accent);letter-spacing:-0.5px}
.project-name{color:var(--text2);font-size:13px}
.header-spacer{flex:1}
.resolve-status{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text2)}
.resolve-dot{width:8px;height:8px;border-radius:50%;background:#555;flex-shrink:0}
.resolve-dot.on{background:var(--green);box-shadow:0 0 6px var(--green)}
.resolve-dot.off{background:var(--accent)}

/* Tab Nav */
.tab-nav{display:flex;gap:0;background:var(--surface);border-bottom:1px solid var(--border);padding:0 20px;flex-shrink:0}
.tab-btn{padding:12px 24px;font-size:13px;font-weight:700;letter-spacing:0.5px;text-transform:uppercase;color:var(--text3);background:transparent;border:none;border-bottom:2px solid transparent;border-radius:0;transition:all var(--transition);position:relative}
.tab-btn:hover{color:var(--text2);filter:none}
.tab-btn.active{color:var(--accent);border-bottom-color:var(--accent)}
.tab-btn .tab-count{font-size:11px;font-weight:600;background:var(--surface2);color:var(--text2);padding:1px 6px;border-radius:8px;margin-left:6px}

/* Tab content */
.tab-content{flex:1;overflow:hidden;display:none;min-height:0}
.tab-content.active{display:flex;flex-direction:column}

/* ‚ïê‚ïê‚ïê TAB 1: CLIPS ‚ïê‚ïê‚ïê */
.clips-stats{display:flex;gap:24px;padding:16px 24px;background:var(--surface);border-bottom:1px solid var(--border);flex-shrink:0;flex-wrap:wrap}
.stat-item{display:flex;flex-direction:column;gap:2px}
.stat-value{font-size:20px;font-weight:700;color:var(--text)}
.stat-label{font-size:11px;color:var(--text2);text-transform:uppercase;letter-spacing:0.5px}
.clips-toolbar{display:flex;align-items:center;gap:10px;padding:12px 24px;flex-shrink:0;flex-wrap:wrap}
.filter-chips{display:flex;gap:6px}
.chip{padding:5px 14px;font-size:12px;font-weight:600;border-radius:20px;background:var(--surface2);color:var(--text2);border:1px solid var(--border);cursor:pointer;transition:all var(--transition)}
.chip:hover{border-color:var(--text3)}
.chip.active{background:var(--accent);color:#fff;border-color:var(--accent)}
.sort-group{display:flex;align-items:center;gap:6px;margin-left:auto}
.sort-group label{font-size:12px;color:var(--text3)}
.sort-group select{padding:4px 8px;font-size:12px}

.clips-body{flex:1;display:flex;overflow:hidden}
.clips-grid-wrap{flex:1;overflow-y:auto;padding:16px 24px}
.clips-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px}
.clip-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);overflow:hidden;cursor:pointer;transition:all var(--transition)}
.clip-card:hover{border-color:var(--border2);transform:translateY(-2px);box-shadow:0 8px 24px #0004}
.clip-card.selected{border-color:var(--accent);box-shadow:0 0 0 1px var(--accent)}
.clip-thumb{width:100%;aspect-ratio:16/9;background:var(--surface2);object-fit:cover;display:block}
.clip-info{padding:10px 12px}
.clip-name{font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.clip-meta{display:flex;align-items:center;gap:6px;margin-top:4px;font-size:12px;color:var(--text2)}
.clip-duration{font-variant-numeric:tabular-nums}
.clip-preview-text{font-size:11px;color:var(--text3);margin-top:6px;line-height:1.4;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}

/* Clip detail panel */
.clip-detail{width:420px;background:var(--surface);border-left:1px solid var(--border);overflow-y:auto;flex-shrink:0;display:none;padding:0}
.clip-detail.open{display:block}
.clip-detail-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--border)}
.clip-detail-header h3{font-size:15px;font-weight:700}
.clip-detail-close{background:transparent;color:var(--text2);font-size:18px;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:var(--radius)}
.clip-detail-thumb{width:100%;aspect-ratio:16/9;object-fit:cover;background:var(--surface2);display:block}
.clip-detail-body{padding:20px}
.detail-row{display:flex;justify-content:space-between;padding:6px 0;font-size:13px;border-bottom:1px solid var(--border)}
.detail-row .label{color:var(--text2)}
.detail-row .value{font-weight:600;text-align:right;max-width:60%;word-break:break-all}
.clip-transcript{margin-top:20px}
.clip-transcript h4{font-size:13px;font-weight:700;margin-bottom:10px;color:var(--text2);text-transform:uppercase;letter-spacing:0.5px}
.transcript-segment{font-size:13px;line-height:1.7;color:var(--text);padding:4px 0}
.transcript-segment .tc{color:var(--text3);font-size:11px;font-variant-numeric:tabular-nums;margin-right:8px}
.no-transcript-msg{color:var(--text3);font-size:13px;font-style:italic}

/* ‚ïê‚ïê‚ïê TAB 2: SCRIPTS ‚ïê‚ïê‚ïê */
.scripts-layout{flex:1;display:flex;overflow:hidden;min-height:0}
.scripts-left{width:420px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;flex-shrink:0}
.scripts-left-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;flex-shrink:0}
.scripts-left-header h3{font-size:14px;font-weight:700;flex:1}
.clip-selector{flex:1;overflow-y:auto;padding:8px 0;min-height:0}
.clip-select-item{display:flex;align-items:center;gap:10px;padding:8px 20px;cursor:pointer;transition:background var(--transition)}
.clip-select-item:hover{background:var(--surface2)}
.clip-select-item input[type="checkbox"]{accent-color:var(--accent);width:16px;height:16px;flex-shrink:0}
.clip-select-thumb{width:48px;height:27px;border-radius:4px;object-fit:cover;background:var(--surface2);flex-shrink:0}
.clip-select-info{flex:1;min-width:0}
.clip-select-name{font-size:12px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.clip-select-meta{font-size:11px;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.selection-summary{padding:12px 20px;border-top:1px solid var(--border);font-size:12px;color:var(--text2);display:flex;align-items:center;gap:8px;flex-shrink:0}
.selection-summary strong{color:var(--text)}

/* Create script form */
.create-script-form{padding:20px;border-top:1px solid var(--border);flex-shrink:0;background:var(--surface2);overflow-y:auto}
.form-label{font-size:12px;font-weight:600;color:var(--text2);margin-bottom:6px;display:block;text-transform:uppercase;letter-spacing:0.3px}
.form-group{margin-bottom:14px}
.form-group input,.form-group select,.form-group textarea{width:100%;font-size:13px}
.form-group textarea{resize:vertical;min-height:60px}
.duration-presets{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:8px}
.dur-btn{padding:4px 10px;font-size:11px;font-weight:600;border-radius:14px;background:var(--surface);color:var(--text2);border:1px solid var(--border);cursor:pointer;transition:all var(--transition)}
.dur-btn:hover{border-color:var(--text3)}
.dur-btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}
.ai-note{font-size:11px;color:var(--text3);font-style:italic;margin-top:8px;line-height:1.4}

/* Scripts right panel */
.scripts-right{flex:1;display:flex;flex-direction:column;overflow:hidden;min-height:0}
.scripts-right-header{display:flex;align-items:center;gap:12px;padding:16px 24px;border-bottom:1px solid var(--border);flex-shrink:0;flex-wrap:wrap}
.scripts-right-header select{font-size:13px;flex:1;max-width:300px}
.script-doc{flex:1;overflow-y:auto;padding:32px}
.script-doc-inner{max-width:720px;margin:0 auto}
.script-title{font-size:22px;font-weight:800;margin-bottom:8px}
.script-subtitle{font-size:13px;color:var(--text2);margin-bottom:24px}
.script-section{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);margin-bottom:12px;overflow:hidden;transition:box-shadow var(--transition)}
.script-section:hover{box-shadow:0 4px 16px #0003}
.script-section-header{display:flex;align-items:center;gap:10px;padding:12px 16px;background:var(--surface2);border-bottom:1px solid var(--border)}
.script-section-name{font-size:14px;font-weight:700;flex:1}
.script-section-name[contenteditable]{outline:none;border-bottom:1px dashed transparent}
.script-section-name[contenteditable]:focus{border-bottom-color:var(--accent)}
.script-section-dur{font-size:12px;color:var(--text2);font-variant-numeric:tabular-nums}
.script-section-body{padding:14px 16px}
.script-clip-ref{font-size:12px;color:var(--blue);font-weight:600;margin-bottom:6px}
.script-section-text{font-size:13px;line-height:1.7;color:var(--text)}
.script-section-controls{display:flex;gap:4px;padding:8px 16px;border-top:1px solid var(--border)}
.script-total{margin-top:20px;padding:16px;text-align:right;font-size:14px;color:var(--text2)}
.script-total strong{color:var(--text);font-size:18px}
.script-empty{text-align:center;padding:80px 20px;color:var(--text3)}
.script-empty h3{font-size:18px;color:var(--text2);margin-bottom:8px}
.script-actions{display:flex;gap:8px;padding:16px 24px;border-top:1px solid var(--border);flex-shrink:0}

/* ‚ïê‚ïê‚ïê TAB 3: TIMELINE ‚ïê‚ïê‚ïê */
.timeline-header{display:flex;align-items:center;gap:12px;padding:12px 24px;background:var(--surface);border-bottom:1px solid var(--border);flex-shrink:0}
.timeline-header h3{font-size:16px;font-weight:700;flex:1}
.timeline-body{flex:1;display:flex;overflow:hidden}
.timeline-script-panel{width:55%;overflow-y:auto;padding:24px 32px;background:var(--doc-bg);border-right:1px solid var(--border)}
.timeline-preview-panel{width:45%;display:flex;flex-direction:column;overflow:hidden}

/* Timeline script document */
.tl-section-header{font-size:12px;font-weight:700;color:var(--accent);text-transform:uppercase;letter-spacing:0.5px;margin:24px 0 12px;padding-bottom:8px;border-bottom:1px solid var(--border)}
.tl-section-header:first-child{margin-top:0}
.tl-segment{display:flex;gap:14px;padding:12px 14px;border-radius:var(--radius);cursor:pointer;transition:all var(--transition);margin-bottom:4px}
.tl-segment:hover{background:var(--surface2)}
.tl-segment.active{background:var(--accent)15;border-left:3px solid var(--accent);padding-left:11px}
.tl-segment-thumb{width:64px;height:36px;border-radius:4px;object-fit:cover;background:var(--surface2);flex-shrink:0}
.tl-segment-content{flex:1;min-width:0}
.tl-segment-speaker{font-size:11px;font-weight:700;color:var(--blue);margin-bottom:2px}
.tl-segment-text{font-size:13px;line-height:1.6;color:var(--text)}
.tl-segment-tc{font-size:11px;color:var(--text3);font-variant-numeric:tabular-nums;flex-shrink:0;text-align:right;min-width:50px;padding-top:2px}

/* Preview panel */
.preview-frame{flex:1;display:flex;align-items:center;justify-content:center;background:var(--bg);padding:20px;min-height:0}
.preview-frame img{max-width:100%;max-height:100%;object-fit:contain;border-radius:var(--radius)}
.preview-placeholder{color:var(--text3);font-size:14px;text-align:center}
.preview-info{padding:16px 20px;border-top:1px solid var(--border);background:var(--surface);flex-shrink:0}
.preview-clip-name{font-size:14px;font-weight:700;margin-bottom:4px}
.preview-clip-tc{font-size:12px;color:var(--text2);font-variant-numeric:tabular-nums}
.preview-controls{display:flex;align-items:center;justify-content:center;gap:8px;padding:12px 20px;border-top:1px solid var(--border);background:var(--surface);flex-shrink:0}
.preview-controls button{width:40px;height:40px;border-radius:50%;background:var(--surface2);color:var(--text);font-size:16px;display:flex;align-items:center;justify-content:center;border:1px solid var(--border)}
.preview-controls button.play-btn{width:48px;height:48px;background:var(--accent);border:none;font-size:18px}
.preview-segment-info{padding:12px 20px;border-top:1px solid var(--border);background:var(--surface);font-size:12px;color:var(--text2);flex-shrink:0}

/* Filmstrip timeline */
.filmstrip{height:80px;background:var(--surface);border-top:1px solid var(--border);display:flex;overflow-x:auto;padding:8px 12px;gap:4px;flex-shrink:0;align-items:stretch}
.filmstrip-block{flex-shrink:0;background:var(--surface2);border:1px solid var(--border);border-radius:6px;display:flex;align-items:center;gap:6px;padding:6px 8px;cursor:pointer;transition:all var(--transition);overflow:hidden}
.filmstrip-block:hover{border-color:var(--border2)}
.filmstrip-block.active{border-color:var(--accent);box-shadow:0 0 0 1px var(--accent)}
.filmstrip-thumb{width:40px;height:28px;border-radius:3px;object-fit:cover;background:var(--bg);flex-shrink:0}
.filmstrip-text{font-size:10px;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;min-width:0}
.filmstrip-dur{font-size:10px;color:var(--text3);flex-shrink:0;font-variant-numeric:tabular-nums}
.filmstrip-total{display:flex;align-items:center;padding:0 12px;font-size:11px;color:var(--text3);flex-shrink:0;font-weight:600}

/* Loading spinner */
.spinner{width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.6s linear infinite;display:inline-block}
@keyframes spin{to{transform:rotate(360deg)}}

/* Toast */
.toast-container{position:fixed;bottom:20px;right:20px;z-index:9999;display:flex;flex-direction:column;gap:8px}
.toast{padding:12px 20px;border-radius:var(--radius);font-size:13px;font-weight:600;animation:slideIn 0.3s ease;box-shadow:0 8px 24px #0006}
.toast.success{background:var(--green-dark);color:#fff}
.toast.error{background:var(--accent);color:#fff}
.toast.info{background:var(--blue);color:#fff}
@keyframes slideIn{from{transform:translateX(100px);opacity:0}to{transform:translateX(0);opacity:1}}

/* Responsive */
@media(max-width:900px){
  .clips-body{flex-direction:column}
  .clip-detail{width:100%;border-left:none;border-top:1px solid var(--border)}
  .scripts-layout{flex-direction:column}
  .scripts-left{width:100%;max-height:50vh}
  .timeline-body{flex-direction:column}
  .timeline-script-panel,.timeline-preview-panel{width:100%}
  .timeline-script-panel{max-height:50vh}
}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê FOLDER PICKER (shown when no project is open) ‚ïê‚ïê‚ïê -->
<div id="folderPicker" style="display:none;position:fixed;inset:0;background:var(--bg);z-index:1000;display:none;flex-direction:column;align-items:center;justify-content:center">
  <div style="width:100%;max-width:640px;padding:32px">
    <div style="text-align:center;margin-bottom:40px">
      <div style="font-size:32px;font-weight:800;color:var(--accent);margin-bottom:8px">ResolveFlow</div>
      <div style="color:var(--text2);font-size:15px">Open a folder with video files to get started</div>
    </div>
    <!-- Recent projects -->
    <div id="recentProjects" style="margin-bottom:32px"></div>
    <!-- Folder browser -->
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);overflow:hidden">
      <div style="display:flex;align-items:center;gap:8px;padding:12px 16px;border-bottom:1px solid var(--border);background:var(--surface2)">
        <button class="btn btn-ghost btn-sm" id="browseUp" onclick="browseUp()" title="Go up">‚Üë</button>
        <input type="text" id="browsePath" style="flex:1;font-size:13px;font-family:monospace" onkeydown="if(event.key==='Enter')browseTo(this.value)">
        <button class="btn btn-accent btn-sm" id="openFolderBtn" onclick="openCurrentFolder()" style="display:none">Open This Folder</button>
      </div>
      <div id="browseList" style="max-height:400px;overflow-y:auto"></div>
    </div>
    <div style="text-align:center;margin-top:16px;color:var(--text3);font-size:12px">
      Folders with video files are highlighted in <span style="color:var(--green)">green</span>
    </div>
  </div>
</div>

<!-- Loading overlay -->
<div id="loadingOverlay" style="display:none;position:fixed;inset:0;background:var(--bg);z-index:2000;flex-direction:column;align-items:center;justify-content:center;gap:16px">
  <div style="width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite"></div>
  <div id="loadingText" style="color:var(--text2);font-size:15px;font-weight:500">Loading project‚Ä¶</div>
  <div id="loadingSubtext" style="color:var(--text3);font-size:12px"></div>
</div>
<style>@keyframes spin{to{transform:rotate(360deg)}}</style>

<!-- App (hidden until project is open) -->
<div id="appMain" style="display:flex;flex-direction:column;flex:1;min-height:0;overflow:hidden">

<!-- Header -->
<div class="header">
  <div class="logo">ResolveFlow</div>
  <div class="project-name" id="projectName">Loading‚Ä¶</div>
  <button onclick="exitProject()" title="Close project" style="background:none;border:1px solid var(--border);color:var(--text2);border-radius:6px;padding:2px 8px;cursor:pointer;font-size:12px;margin-left:6px">‚úï</button>
  <div class="header-spacer"></div>
  <div class="resolve-status">
    <div class="resolve-dot" id="resolveDot"></div>
    <span id="resolveLabel">Checking‚Ä¶</span>
  </div>
  <button class="btn btn-secondary btn-sm" onclick="doIngest()">‚ü≥ Rescan</button>
  <button class="btn btn-accent btn-sm" id="transcribeBtn" onclick="doTranscribe()">Transcribe All</button>
  <button class="btn btn-secondary btn-sm" onclick="openHelp()" title="Help" style="font-size:16px;padding:4px 10px">?</button>
  <button class="btn btn-secondary btn-sm" onclick="openSettings()" title="Settings" style="font-size:16px;padding:4px 10px">‚öô</button>
</div>

<!-- Tab Nav -->
<div class="tab-nav">
  <button class="tab-btn active" data-tab="clips" onclick="switchTab('clips')">Clips <span class="tab-count" id="clipCount">0</span></button>
  <button class="tab-btn" data-tab="scripts" onclick="switchTab('scripts')">Scripts <span class="tab-count" id="scriptCount">0</span></button>
  <button class="tab-btn" data-tab="timeline" onclick="switchTab('timeline')">Timeline</button>
</div>

<!-- ‚ïê‚ïê‚ïê CLIPS TAB ‚ïê‚ïê‚ïê -->
<div class="tab-content active" id="tab-clips">
  <div class="clips-stats" id="clipsStats"></div>
  <div class="clips-toolbar">
    <div class="filter-chips">
      <button class="chip active" data-filter="all" onclick="setFilter('all',this)">All</button>
      <button class="chip" data-filter="Sony" onclick="setFilter('Sony',this)">Sony</button>
      <button class="chip" data-filter="DJI" onclick="setFilter('DJI',this)">DJI</button>
      <button class="chip" data-filter="transcribed" onclick="setFilter('transcribed',this)">Transcribed</button>
      <button class="chip" data-filter="pending" onclick="setFilter('pending',this)">Pending</button>
    </div>
    <div class="sort-group">
      <label>Sort:</label>
      <select id="sortSelect" onchange="renderClips()">
        <option value="name">Name</option>
        <option value="duration">Duration</option>
        <option value="camera">Device</option>
      </select>
    </div>
  </div>
  <div class="clips-body">
    <div class="clips-grid-wrap">
      <div class="clips-grid" id="clipsGrid"></div>
    </div>
    <div class="clip-detail" id="clipDetail"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê SCRIPTS TAB ‚ïê‚ïê‚ïê -->
<div class="tab-content" id="tab-scripts">
  <div class="scripts-layout">
    <div class="scripts-left">
      <div class="scripts-left-header">
        <h3>Select Clips</h3>
        <button class="btn btn-ghost btn-sm" onclick="selectAllClips()">Select All</button>
        <button class="btn btn-ghost btn-sm" onclick="clearClipSelection()">Clear</button>
      </div>
      <div class="clip-selector" id="clipSelector"></div>
      <div class="selection-summary" id="selectionSummary">
        <strong>0</strong> clips selected ¬∑ <span>0:00</span> total
      </div>
    </div>
    <div class="scripts-right">
      <div class="scripts-right-header">
        <select id="scriptSelect" onchange="loadScript(this.value)">
          <option value="">‚Äî Select a script ‚Äî</option>
        </select>
        <button class="btn btn-accent btn-sm" onclick="showNewScriptModal()">+ New Script</button>
        <button class="btn btn-secondary btn-sm" onclick="duplicateScript()">Duplicate</button>
        <button class="btn btn-secondary btn-sm" style="color:var(--accent)" onclick="deleteScript()">Delete</button>
        <button class="btn btn-secondary btn-sm" style="color:#f44" onclick="deleteAllScripts()">Delete All</button>
      </div>
      <div class="script-doc" id="scriptDoc">
        <div class="script-empty">
          <h3>No script loaded</h3>
          <p>Select clips on the left and generate a script with AI,<br>or choose an existing script above.</p>
        </div>
      </div>
      <!-- AI Refine Chat -->
      <div id="refinePanel" style="display:none;border-top:1px solid var(--border);padding:16px 24px;background:var(--surface)">
        <h4 style="font-size:13px;font-weight:600;margin-bottom:8px;color:var(--text2)">üí¨ Refine with AI</h4>
        <div id="refineChat" style="max-height:200px;overflow-y:auto;margin-bottom:10px;font-size:13px;line-height:1.6"></div>
        <div style="display:flex;gap:8px">
          <input id="refineInput" type="text" placeholder="e.g. Make it flow better, find a stronger opening, cut the ending..." 
            style="flex:1;padding:10px 14px;font-size:13px" onkeydown="if(event.key==='Enter')refineScript()">
          <button class="btn btn-primary" onclick="refineScript()" id="refineBtn">Refine</button>
        </div>
        <div style="margin-top:6px;font-size:11px;color:var(--text3)">AI will pick better segments from your clips to improve coherence. It won't make up new dialog.</div>
      </div>
      <div class="script-actions" id="scriptActions" style="display:none">
        <button class="btn btn-secondary" onclick="toggleRefine()">üí¨ Refine with AI</button>
        <div style="flex:1"></div>
        <button class="btn btn-green btn-lg" onclick="openInTimeline()">Open in Timeline ‚Üí</button>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê TIMELINE TAB ‚ïê‚ïê‚ïê -->
<div class="tab-content" id="tab-timeline">
  <div class="timeline-header">
    <button class="btn btn-ghost btn-sm" onclick="switchTab('scripts')">‚Üê Scripts</button>
    <h3 id="timelineTitle" contenteditable="true" style="outline:none;border-bottom:1px dashed transparent;cursor:text"
        onfocus="this.style.borderBottomColor='var(--accent)'"
        onblur="this.style.borderBottomColor='transparent';saveScriptTitle(this.textContent)"
        title="Click to edit title">No script loaded</h3>
    <span id="timelineDuration" style="font-size:13px;color:var(--text2)"></span>
    <div style="flex:1"></div>
    <button class="btn btn-secondary" onclick="exportEDL()">Export EDL</button>
    <button class="btn btn-green btn-lg" onclick="sendToResolve()">üé¨ Send to Resolve</button>
  </div>
  <div class="timeline-body">
    <div class="timeline-script-panel" id="timelineScriptPanel"></div>
    <div class="timeline-preview-panel">
      <div class="preview-frame" id="previewFrame">
        <div class="preview-placeholder">Select a segment to preview</div>
      </div>
      <div class="preview-controls">
        <button onclick="prevSegment()">‚èÆ</button>
        <button class="play-btn">‚ñ∂</button>
        <button onclick="nextSegment()">‚è≠</button>
      </div>
      <div class="preview-info" id="previewInfo">
        <div class="preview-clip-name">‚Äî</div>
        <div class="preview-clip-tc">‚Äî</div>
      </div>
      <div class="preview-segment-info" id="previewSegmentInfo">Select a segment to see details</div>
    </div>
  </div>
  <div class="filmstrip" id="filmstrip"></div>
</div>

<!-- Clip Info Modal -->
<div id="clipInfoModal" style="display:none;position:fixed;inset:0;z-index:500;background:rgba(0,0,0,0.6);backdrop-filter:blur(4px);align-items:center;justify-content:center" onclick="if(event.target===this)this.style.display='none'">
  <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);width:560px;max-width:90vw;max-height:85vh;overflow-y:auto;box-shadow:0 24px 48px rgba(0,0,0,0.4)">
    <div style="display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid var(--border)">
      <h2 style="font-size:16px;font-weight:800" id="clipInfoTitle">Clip Detail</h2>
      <button class="btn btn-ghost" onclick="document.getElementById('clipInfoModal').style.display='none'" style="font-size:18px;width:32px;height:32px;display:flex;align-items:center;justify-content:center">‚úï</button>
    </div>
    <div id="clipInfoBody" style="padding:20px"></div>
  </div>
</div>

<!-- New Script Modal -->
<div id="newScriptModal" style="display:none;position:fixed;inset:0;z-index:500;background:rgba(0,0,0,0.6);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center" onclick="if(event.target===this)hideNewScriptModal()">
  <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);width:480px;max-width:90vw;max-height:90vh;overflow-y:auto;box-shadow:0 24px 48px rgba(0,0,0,0.4)">
    <div style="display:flex;align-items:center;justify-content:space-between;padding:20px 24px;border-bottom:1px solid var(--border)">
      <h2 style="font-size:18px;font-weight:800">‚ú® New AI Script</h2>
      <button class="btn btn-ghost" onclick="hideNewScriptModal()" style="font-size:18px;width:32px;height:32px;display:flex;align-items:center;justify-content:center">‚úï</button>
    </div>
    <div style="padding:24px">
      <div class="form-group">
        <label class="form-label">Script Name</label>
        <input type="text" id="scriptNameInput" placeholder="My Edit" style="width:100%">
      </div>
      <div class="form-group">
        <label class="form-label">Target Duration</label>
        <div class="duration-presets" id="durPresets">
          <button class="dur-btn" data-dur="30">30s</button>
          <button class="dur-btn" data-dur="60">1min</button>
          <button class="dur-btn active" data-dur="120">2min</button>
          <button class="dur-btn" data-dur="300">5min</button>
          <button class="dur-btn" data-dur="600">10min</button>
          <button class="dur-btn" data-dur="0">Full</button>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Style</label>
        <select id="styleSelect" style="width:100%">
          <option>Highlight Reel</option>
          <option>Documentary</option>
          <option>Interview</option>
          <option>Social Media</option>
          <option>Tutorial</option>
          <option>Custom</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Clips</label>
        <div style="font-size:13px;color:var(--text2)" id="modalClipSummary">0 clips selected</div>
        <div style="font-size:11px;color:var(--text3);margin-top:4px">Select clips from the left panel before generating</div>
      </div>
      <div class="form-group">
        <label class="form-label">Instructions (optional)</label>
        <textarea id="promptInput" placeholder="What should this video be about? What's the story? Any specific moments to include?" rows="4" style="width:100%"></textarea>
      </div>
      <button class="btn btn-accent btn-lg" style="width:100%" id="generateBtn" onclick="generateScript()">‚ú® Generate with AI</button>
      <div style="font-size:11px;color:var(--text3);font-style:italic;margin-top:10px;text-align:center">AI arranges and trims existing clips ‚Äî it cannot create new dialog.</div>
    </div>
  </div>
</div>

</div><!-- end appMain -->

<div class="toast-container" id="toasts"></div>

<script>
// ‚îÄ‚îÄ State ‚îÄ‚îÄ
const S = {
  activeTab: 'clips',
  clips: [],
  filter: 'all',
  selectedClipDetail: null,
  selectedClips: new Set(),
  scripts: [],
  currentScript: null,
  currentScriptData: null,
  timelineScript: null,
  timelineSegmentIndex: 0,
  transcripts: {},
  targetDuration: 120,
};

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
const api = async (path, opts) => {
  const r = await fetch(`/api${path}`, opts);
  if (!r.ok) throw new Error(`API ${r.status}`);
  const ct = r.headers.get('content-type') || '';
  return ct.includes('json') ? r.json() : r.text();
};
const apiPost = (path, body) => api(path, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});

function fmtDur(s) {
  if (!s || s < 0) return '0:00';
  const m = Math.floor(s / 60), sec = Math.floor(s % 60);
  return `${m}:${sec.toString().padStart(2, '0')}`;
}
function fmtDurLong(s) {
  if (!s) return '0s';
  if (s < 60) return `${Math.round(s)}s`;
  const m = Math.floor(s / 60), sec = Math.round(s % 60);
  return sec ? `${m}m ${sec}s` : `${m}m`;
}

function toast(msg, type='info') {
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  el.textContent = msg;
  $('#toasts').appendChild(el);
  setTimeout(() => el.remove(), 4000);
}

const clipColors = ['#e94560','#3b82f6','#10b981','#f59e0b','#8b5cf6','#ec4899','#06b6d4','#f97316'];
function clipColor(id) { return clipColors[(id - 1) % clipColors.length]; }

// ‚îÄ‚îÄ Tab switching ‚îÄ‚îÄ
function switchTab(tab) {
  S.activeTab = tab;
  $$('.tab-btn').forEach(b => b.classList.toggle('active', b.dataset.tab === tab));
  $$('.tab-content').forEach(c => c.classList.toggle('active', c.id === `tab-${tab}`));
  if (tab === 'scripts') { renderClipSelector(); loadScriptsList(); }
  if (tab === 'timeline' && S.timelineScript) renderTimeline();
}

// ‚îÄ‚îÄ Data loading ‚îÄ‚îÄ
function showLoading(text, subtext) {
  const el = document.getElementById('loadingOverlay');
  document.getElementById('loadingText').textContent = text || 'Loading‚Ä¶';
  document.getElementById('loadingSubtext').textContent = subtext || '';
  el.style.display = 'flex';
}
function hideLoading() {
  document.getElementById('loadingOverlay').style.display = 'none';
}
function updateLoading(text, subtext) {
  if (text) document.getElementById('loadingText').textContent = text;
  if (subtext !== undefined) document.getElementById('loadingSubtext').textContent = subtext;
}

async function loadAll() {
  try {
    updateLoading('Loading clips‚Ä¶', 'Fetching project data');
    const [project, clips, resolveStatus] = await Promise.all([
      api('/project'), api('/clips'), api('/resolve/status')
    ]);
    S.clips = clips;
    $('#projectName').textContent = project.name || project.path;
    $('#clipCount').textContent = clips.length;
    $('#resolveDot').className = `resolve-dot ${resolveStatus.connected ? 'on' : 'off'}`;
    $('#resolveLabel').textContent = resolveStatus.connected
      ? `Resolve: ${resolveStatus.project || 'Connected'}` : 'Resolve: Offline';
    updateLoading('Rendering‚Ä¶', `${clips.length} clips loaded`);
    renderClipsStats();
    renderClips();
    await loadScriptsList();
    hideLoading();
  } catch(e) { hideLoading(); toast('Failed to load: ' + e.message, 'error'); }
}

// ‚îÄ‚îÄ CLIPS TAB ‚îÄ‚îÄ
function renderClipsStats() {
  const clips = S.clips;
  const total = clips.length;
  const dur = clips.reduce((a, c) => a + (c.duration_seconds || 0), 0);
  const sony = clips.filter(c => c.camera === 'Sony').length;
  const dji = clips.filter(c => c.camera === 'DJI').length;
  const transcribed = clips.filter(c => c.has_transcript).length;
  $('#clipsStats').innerHTML = `
    <div class="stat-item"><div class="stat-value">${total}</div><div class="stat-label">Clips</div></div>
    <div class="stat-item"><div class="stat-value">${fmtDurLong(dur)}</div><div class="stat-label">Total Duration</div></div>
    <div class="stat-item"><div class="stat-value">${sony}</div><div class="stat-label">Sony</div></div>
    <div class="stat-item"><div class="stat-value">${dji}</div><div class="stat-label">DJI</div></div>
    <div class="stat-item"><div class="stat-value">${transcribed}/${total}</div><div class="stat-label">Transcribed</div></div>
  `;
}

function setFilter(f, el) {
  S.filter = f;
  $$('.filter-chips .chip').forEach(c => c.classList.toggle('active', c === el));
  renderClips();
}

function getFilteredClips() {
  let clips = [...S.clips];
  if (S.filter === 'Sony') clips = clips.filter(c => c.camera === 'Sony');
  else if (S.filter === 'DJI') clips = clips.filter(c => c.camera === 'DJI');
  else if (S.filter === 'transcribed') clips = clips.filter(c => c.has_transcript);
  else if (S.filter === 'pending') clips = clips.filter(c => !c.has_transcript);

  const sort = $('#sortSelect').value;
  if (sort === 'name') clips.sort((a,b) => a.filename.localeCompare(b.filename));
  else if (sort === 'duration') clips.sort((a,b) => (b.duration_seconds||0) - (a.duration_seconds||0));
  else if (sort === 'camera') clips.sort((a,b) => (a.camera||'').localeCompare(b.camera||''));
  return clips;
}

function renderClips() {
  const clips = getFilteredClips();
  const grid = $('#clipsGrid');
  grid.innerHTML = clips.map(c => `
    <div class="clip-card ${S.selectedClipDetail === c.id ? 'selected' : ''}" onclick="showClipDetail(${c.id})">
      <img class="clip-thumb" src="/api/thumbnails/${c.id}" onerror="this.style.background='var(--surface2)';this.src=''" loading="lazy">
      <div class="clip-info">
        <div class="clip-name">${escHtml(c.filename)}${c.ai_title ? ` <span style="color:var(--text2);font-weight:400">‚Äî ${escHtml(c.ai_title)}</span>` : ''}</div>
        <div class="clip-meta">
          <span class="clip-duration">${fmtDur(c.duration_seconds)}</span>
          <span class="badge badge-${(c.camera||'unknown').toLowerCase()}">${c.camera||'?'}</span>
          ${c.has_transcript ? '<span class="badge badge-transcribed">‚úì</span>' : '<span class="badge badge-pending">‚Ä¶</span>'}
        </div>
        ${c.ai_summary ? `<div class="clip-preview-text">${escHtml(c.ai_summary)}</div>` : (c.transcript_preview ? `<div class="clip-preview-text">${escHtml(c.transcript_preview)}</div>` : '')}
      </div>
    </div>
  `).join('');
}

function escHtml(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

async function showClipDetail(id) {
  S.selectedClipDetail = id;
  renderClips();
  const clip = S.clips.find(c => c.id === id);
  if (!clip) return;

  const panel = $('#clipDetail');
  panel.classList.add('open');

  // Load transcript
  let transcriptHtml = '<div class="no-transcript-msg">No transcript available</div>';
  if (clip.has_transcript) {
    try {
      const t = await api(`/transcript/${id}`);
      if (t && t.segments && t.segments.length) {
        transcriptHtml = t.segments.map(s =>
          `<div class="transcript-segment"><span class="tc">[${fmtDur(s.start)}]</span>${escHtml(s.text)}</div>`
        ).join('');
        S.transcripts[id] = t;
      } else if (t && t.full_text) {
        transcriptHtml = `<div class="transcript-segment">${escHtml(t.full_text)}</div>`;
      }
    } catch(e) {}
  }

  panel.innerHTML = `
    <div class="clip-detail-header">
      <h3>${escHtml(clip.filename)}</h3>
      <button class="clip-detail-close" onclick="closeClipDetail()">‚úï</button>
    </div>
    <img class="clip-detail-thumb" src="/api/thumbnails/${id}" onerror="this.style.display='none'">
    <div class="clip-detail-body">
      <div class="detail-row"><span class="label">Duration</span><span class="value">${fmtDurLong(clip.duration_seconds)}</span></div>
      <div class="detail-row"><span class="label">Resolution</span><span class="value">${clip.resolution || '‚Äî'}</span></div>
      <div class="detail-row"><span class="label">Codec</span><span class="value">${clip.codec || '‚Äî'}</span></div>
      <div class="detail-row"><span class="label">Camera</span><span class="value">${clip.camera || '‚Äî'}</span></div>
      <div class="detail-row"><span class="label">FPS</span><span class="value">${clip.fps || '‚Äî'}</span></div>
      <div class="detail-row"><span class="label">Path</span><span class="value" style="font-size:11px">${escHtml(clip.relative_path || '')}</span></div>
      <div class="clip-transcript">
        <h4>Transcript</h4>
        ${transcriptHtml}
      </div>
    </div>
  `;
}

function closeClipDetail() {
  S.selectedClipDetail = null;
  $('#clipDetail').classList.remove('open');
  renderClips();
}

// ‚îÄ‚îÄ SCRIPTS TAB ‚îÄ‚îÄ
function renderClipSelector() {
  const clips = S.clips.filter(c => c.has_transcript);
  $('#clipSelector').innerHTML = clips.length ? clips.map(c => `
    <div class="clip-select-item">
      <input type="checkbox" ${S.selectedClips.has(c.id)?'checked':''} onchange="toggleClipSelect(${c.id},this.checked)">
      <img class="clip-select-thumb" src="/api/thumbnails/${c.id}" onerror="this.style.background='var(--surface2)'">
      <div class="clip-select-info" onclick="toggleClipSelect(${c.id},!S.selectedClips.has(${c.id}));renderClipSelector()">
        <div class="clip-select-name">${escHtml(c.filename)}${c.ai_title ? ` ‚Äî ${escHtml(c.ai_title)}` : ''}</div>
        <div class="clip-select-meta">${fmtDur(c.duration_seconds)} ¬∑ ${escHtml(c.ai_summary || (c.transcript_preview||'').slice(0,60))}</div>
      </div>
      <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();showClipInfoModal(${c.id})" title="Clip details" style="font-size:14px;padding:4px 6px;flex-shrink:0;opacity:0.5" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0.5">‚ÑπÔ∏è</button>
    </div>
  `).join('') : '<div style="padding:20px;color:var(--text3);text-align:center">No transcribed clips yet</div>';
  updateSelectionSummary();
}

function toggleClipSelect(id, checked) {
  if (checked) S.selectedClips.add(id); else S.selectedClips.delete(id);
  updateSelectionSummary();
}
function selectAllClips() {
  S.clips.filter(c => c.has_transcript).forEach(c => S.selectedClips.add(c.id));
  renderClipSelector();
}
function clearClipSelection() {
  S.selectedClips.clear();
  renderClipSelector();
}
function updateSelectionSummary() {
  const sel = [...S.selectedClips];
  const dur = sel.reduce((a, id) => {
    const c = S.clips.find(x => x.id === id);
    return a + (c ? c.duration_seconds || 0 : 0);
  }, 0);
  $('#selectionSummary').innerHTML = `<strong>${sel.length}</strong> clips selected ¬∑ <span>${fmtDurLong(dur)}</span> total`;
}

// Duration presets
document.addEventListener('click', e => {
  if (e.target.classList.contains('dur-btn')) {
    $$('.dur-btn').forEach(b => b.classList.remove('active'));
    e.target.classList.add('active');
    S.targetDuration = parseInt(e.target.dataset.dur) || 0;
  }
});

async function generateScript() {
  const clipIds = S.selectedClips.size > 0 ? [...S.selectedClips] : S.clips.map(c => c.id);
  if (clipIds.length === 0) { toast('No clips available', 'error'); return; }
  const btn = $('#generateBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Generating‚Ä¶';
  try {
    const result = await apiPost('/ai/auto-edit', {
      clip_ids: clipIds,
      target_duration: S.targetDuration || 9999,
      style: $('#styleSelect').value,
      prompt: $('#promptInput').value || '',
      script_name: $('#scriptNameInput').value || undefined
    });
    if (result.error) { toast(result.error, 'error'); return; }
    hideNewScriptModal();
    toast(`Script created: ${result.script_name}`, 'success');
    await loadScriptsList();
    if (result.script_id) {
      $('#scriptSelect').value = result.script_id;
      loadScript(result.script_id);
    }
  } catch(e) { toast('Generation failed: ' + e.message, 'error'); }
  finally { btn.disabled = false; btn.innerHTML = '‚ú® Generate with AI'; }
}

async function loadScriptsList() {
  try {
    S.scripts = await api('/scripts');
    $('#scriptCount').textContent = S.scripts.length;
    const sel = $('#scriptSelect');
    const curVal = sel.value;
    sel.innerHTML = '<option value="">‚Äî Select a script ‚Äî</option>' +
      S.scripts.map(s => `<option value="${s.id}">${escHtml(s.name)} (${fmtDurLong(s.target_duration_seconds)})</option>`).join('');
    if (curVal) sel.value = curVal;
  } catch(e) {}
}

async function loadScript(id) {
  if (!id) { renderScriptEmpty(); return; }
  try {
    const data = await api(`/script/${id}`);
    S.currentScript = id;
    S.currentScriptData = data;
    renderScript(data);
  } catch(e) { toast('Failed to load script', 'error'); }
}

function renderScriptEmpty() {
  S.currentScript = null;
  S.currentScriptData = null;
  $('#scriptDoc').innerHTML = `<div class="script-empty"><h3>No script loaded</h3><p>Select clips and generate with AI, or choose an existing script above.</p></div>`;
  $('#scriptActions').style.display = 'none';
}

const SEG_COLORS = ['#e94560','#4ecca3','#e9a645','#a78bfa','#38bdf8','#f472b6','#34d399','#fb923c','#818cf8','#22d3ee'];

function renderScript(data) {
  const script = data.script;
  const segments = data.segments || [];
  const totalDur = segments.reduce((a, s) => a + ((s.end_time||0) - (s.start_time||0)), 0);
  const inner = $('#scriptDoc');

  let html = `<div style="padding:24px;">
    <h2 contenteditable="true" style="font-size:20px;font-weight:700;margin-bottom:4px;color:var(--text);outline:none;border-bottom:1px dashed transparent;cursor:text" 
        onfocus="this.style.borderBottomColor='var(--accent)'" 
        onblur="this.style.borderBottomColor='transparent';saveScriptTitle(this.textContent)"
        title="Click to edit title">${escHtml(script.name)}</h2>
    <p style="font-size:13px;color:var(--text3);margin-bottom:20px">${fmtDurLong(totalDur)} ¬∑ ${segments.length} segments</p>
    <div style="display:flex;gap:24px;">
      <!-- Outline column -->
      <div style="width:240px;flex-shrink:0;">
        <h4 style="font-size:12px;text-transform:uppercase;letter-spacing:1px;color:var(--text3);margin-bottom:12px">Outline</h4>`;

  segments.forEach((seg, i) => {
    const color = SEG_COLORS[i % SEG_COLORS.length];
    html += `<div style="padding:8px 10px;margin-bottom:4px;border-radius:6px;cursor:pointer;border-left:3px solid ${color};background:var(--surface);font-size:12px" onclick="scrollToSegText(${i})">
      <div style="font-weight:600;color:var(--text);margin-bottom:2px">${escHtml(seg.section_name || 'Section '+(i+1))}</div>
      <div style="color:var(--text3)">${escHtml(seg.filename||'')} ¬∑ ${fmtDur(seg.start_time)}‚Üí${fmtDur(seg.end_time)}</div>
    </div>`;
  });

  html += `</div>
      <!-- Full text column -->
      <div style="flex:1;min-width:0;">
        <h4 style="font-size:12px;text-transform:uppercase;letter-spacing:1px;color:var(--text3);margin-bottom:12px">Full Script</h4>`;

  segments.forEach((seg, i) => {
    const color = SEG_COLORS[i % SEG_COLORS.length];
    const text = seg.transcript_text || '';
    if (text.trim()) {
      // Wrap each word in a span for selection/removal
      const cutWords = new Set(JSON.parse(seg.cut_words || '[]'));
      const words = text.split(/(\s+)/);
      const wordHtml = words.map((w, wi) => {
        if (/^\s+$/.test(w)) return w;
        const isCut = cutWords.has(wi);
        const cutStyle = isCut ? 'text-decoration:line-through;opacity:0.3;background:rgba(233,69,96,0.15);' : '';
        const cutClass = isCut ? ' word-cut' : '';
        return `<span class="script-word${cutClass}" data-seg="${i}" data-wi="${wi}" style="cursor:pointer;border-radius:2px;padding:0 1px;transition:all .15s;${cutStyle}">${escHtml(w)}</span>`;
      }).join('');
      html += `<div id="seg-text-${i}" style="margin-bottom:16px;padding:16px 20px;background:var(--doc-bg, #1e2235);border-radius:8px;border-left:3px solid ${color}">
        <p style="font-size:15px;line-height:1.8;color:var(--text);margin:0">${wordHtml}</p>
      </div>`;
    }
  });

  html += `</div></div></div>`;
  inner.innerHTML = html;
  inner.style.overflowY = 'auto';
  $('#scriptActions').style.display = 'flex';
}

function scrollToSegText(idx) {
  const el = document.getElementById('seg-text-' + idx);
  if (el) el.scrollIntoView({behavior:'smooth', block:'center'});
}

// Word selection and editing
function cutWord(el) {
  el.classList.add('word-cut');
  el.style.textDecoration = 'line-through';
  el.style.opacity = '0.3';
  el.style.background = 'rgba(233,69,96,0.15)';
  el.classList.remove('word-selected');
  el.style.outline = '';
  saveCutWords(el.dataset.seg);
}
function restoreWord(el) {
  el.classList.remove('word-cut');
  el.style.textDecoration = '';
  el.style.opacity = '';
  el.style.background = '';
  saveCutWords(el.dataset.seg);
}

async function saveCutWords(segIdx) {
  if (!S.currentScript || !S.currentScriptData) return;
  const seg = S.currentScriptData.segments[segIdx];
  if (!seg) return;
  // Collect cut word indices for this segment
  const cutIndices = [];
  document.querySelectorAll(`.script-word[data-seg="${segIdx}"].word-cut`).forEach(el => {
    cutIndices.push(parseInt(el.dataset.wi));
  });
  try {
    await fetch(`/api/script/${S.currentScript}/segment/${seg.id}`, {
      method: 'PUT',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({cut_words: JSON.stringify(cutIndices)})
    });
  } catch(e) { console.error('Failed to save cuts', e); }
}
function selectWord(el) {
  el.classList.add('word-selected');
  el.style.background = 'rgba(78,204,163,0.25)';
  el.style.borderRadius = '2px';
}
function deselectWord(el) {
  el.classList.remove('word-selected');
  el.style.background = el.classList.contains('word-cut') ? 'rgba(233,69,96,0.15)' : '';
}
function clearSelection() {
  document.querySelectorAll('.word-selected').forEach(deselectWord);
  hideWordMenu();
}

// Pending word elements to cut ‚Äî stored when menu appears, consumed on Cut click
let _pendingCutWords = [];

// Floating menu
function showWordMenu() {
  let menu = $('#wordMenu');
  if (!menu) {
    menu = document.createElement('div');
    menu.id = 'wordMenu';
    menu.style.cssText = 'position:fixed;z-index:999;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:4px;display:none;box-shadow:0 8px 24px #0006;gap:4px;display:flex';
    menu.innerHTML = `
      <button class="btn btn-small" style="background:var(--accent);color:#fff;font-size:12px;padding:6px 14px" onmousedown="event.preventDefault()" onclick="cutSelected()">‚úÇÔ∏è Cut</button>
      <button class="btn btn-small" style="background:var(--bg3);color:var(--text);font-size:12px;padding:6px 14px" onmousedown="event.preventDefault()" onclick="clearSelection()">Cancel</button>
    `;
    document.body.appendChild(menu);
  }

  // Capture the words to cut NOW (before any click event can clear them)
  _pendingCutWords = [];

  // First: custom .word-selected
  document.querySelectorAll('.word-selected').forEach(w => _pendingCutWords.push(w));

  // Second: if no custom selection, capture from native browser selection
  if (_pendingCutWords.length === 0) {
    const nativeSel = window.getSelection();
    if (nativeSel && nativeSel.toString().trim().length > 0) {
      document.querySelectorAll('.script-word').forEach(w => {
        if (!w.classList.contains('word-cut') && nativeSel.containsNode(w, true)) {
          _pendingCutWords.push(w);
        }
      });
    }
  }

  console.log('[MENU] Showing menu with', _pendingCutWords.length, 'pending words:', _pendingCutWords.map(w => w.textContent).join(' '));

  // Position near the last selected word
  const posRef = _pendingCutWords[_pendingCutWords.length - 1] || document.querySelector('.word-selected');
  if (posRef) {
    const rect = posRef.getBoundingClientRect();
    menu.style.display = 'flex';
    menu.style.top = (rect.top - 40) + 'px';
    menu.style.left = Math.min(rect.left, window.innerWidth - 160) + 'px';
  }
}
function hideWordMenu() {
  const menu = $('#wordMenu');
  if (menu) menu.style.display = 'none';
  _pendingCutWords = [];
}
function cutSelected() {
  console.log('[CUT] cutSelected called, pending words:', _pendingCutWords.length);

  if (_pendingCutWords.length === 0) {
    console.log('[CUT] No words to cut!');
    hideWordMenu();
    return;
  }

  console.log('[CUT] Cutting', _pendingCutWords.length, 'words:', _pendingCutWords.map(w => w.textContent).join(' '));
  _pendingCutWords.forEach(cutWord);
  window.getSelection()?.removeAllRanges(); // clear native selection
  _pendingCutWords = [];
  hideWordMenu();
}

// Mouse interaction for text selection
let isSelecting = false;
document.addEventListener('mousedown', (e) => {
  // Don't clear selection when clicking the word menu buttons
  if (e.target.closest?.('#wordMenu')) return;
  const w = e.target.closest?.('.script-word');
  if (!w) { clearSelection(); return; }
  if (w.classList.contains('word-cut')) return;
  isSelecting = true;
  clearSelection();
  selectWord(w);
  e.preventDefault();
});
document.addEventListener('mouseover', (e) => {
  const w = e.target.closest?.('.script-word');
  if (!w) return;
  if (w.classList.contains('word-cut') && !isSelecting) {
    w.style.opacity = '0.6';
    w.style.cursor = 'pointer';
    w.title = 'Click to restore';
    return;
  }
  if (isSelecting && !w.classList.contains('word-cut')) {
    selectWord(w);
  }
});
document.addEventListener('mouseout', (e) => {
  const w = e.target.closest?.('.script-word');
  if (w && w.classList.contains('word-cut') && !w.classList.contains('word-selected')) {
    w.style.opacity = '0.3';
    w.title = '';
  }
});
document.addEventListener('mouseup', (e) => {
  if (isSelecting) {
    isSelecting = false;
    const selected = document.querySelectorAll('.word-selected');
    console.log('[SEL] Custom mouseup, selected:', selected.length);
    if (selected.length > 0) showWordMenu();
  } else {
    // Check for native browser selection over script words
    setTimeout(() => {
      const nativeSel = window.getSelection();
      if (nativeSel && nativeSel.toString().trim().length > 0) {
        // Check if any script-word spans are within the native selection
        let hasScriptWords = false;
        document.querySelectorAll('.script-word').forEach(w => {
          if (!w.classList.contains('word-cut') && nativeSel.containsNode(w, true)) {
            hasScriptWords = true;
          }
        });
        if (hasScriptWords) {
          console.log('[SEL] Native selection detected over script words:', nativeSel.toString().substring(0, 50));
          showWordMenu();
        }
      }
    }, 50);
  }
  // Click on cut word to restore
  const w = e.target.closest?.('.script-word');
  if (w && w.classList.contains('word-cut') && !document.querySelectorAll('.word-selected').length) {
    restoreWord(w);
  }
});

function toggleRefine() {
  const p = $('#refinePanel');
  p.style.display = p.style.display === 'none' ? 'block' : 'none';
  if (p.style.display === 'block') $('#refineInput').focus();
}

async function refineScript() {
  if (!S.currentScriptData) return;
  const input = $('#refineInput');
  const feedback = input.value.trim();
  if (!feedback) return;
  
  const chat = $('#refineChat');
  chat.innerHTML += `<div style="margin-bottom:8px"><strong style="color:var(--text)">You:</strong> <span style="color:var(--text2)">${escHtml(feedback)}</span></div>`;
  chat.innerHTML += `<div style="margin-bottom:8px;color:var(--accent)" id="refineLoading">‚è≥ AI is refining the script...</div>`;
  chat.scrollTop = chat.scrollHeight;
  input.value = '';
  $('#refineBtn').disabled = true;
  
  try {
    const res = await fetch('/api/ai/refine', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({script_id: S.currentScriptData.script.id, feedback})
    });
    const data = await res.json();
    const loading = $('#refineLoading');
    if (loading) loading.remove();
    
    if (data.error) {
      chat.innerHTML += `<div style="margin-bottom:8px;color:var(--accent)">‚ùå ${escHtml(data.error)}</div>`;
    } else {
      const segCount = (data.segments||[]).length;
      const dur = (data.segments||[]).reduce((a,s) => a + ((s.end_time||0)-(s.start_time||0)), 0);
      chat.innerHTML += `<div style="margin-bottom:8px"><strong style="color:var(--green)">AI:</strong> <span style="color:var(--text2)">Script refined ‚Äî ${segCount} segments, ${fmtDurLong(dur)}. Check the updated script above.</span></div>`;
      S.currentScriptData = data;
      renderScript(data);
    }
  } catch(e) {
    const loading = $('#refineLoading');
    if (loading) loading.remove();
    chat.innerHTML += `<div style="margin-bottom:8px;color:var(--accent)">‚ùå ${e.message}</div>`;
  }
  chat.scrollTop = chat.scrollHeight;
  $('#refineBtn').disabled = false;
}

async function updateSectionName(idx, name) {
  if (!S.currentScriptData) return;
  S.currentScriptData.segments[idx].section_name = name;
  await saveSegments();
}

async function moveSection(idx, dir) {
  if (!S.currentScriptData) return;
  const segs = S.currentScriptData.segments;
  const target = idx + dir;
  if (target < 0 || target >= segs.length) return;
  [segs[idx], segs[target]] = [segs[target], segs[idx]];
  segs.forEach((s, i) => s.order_index = i);
  await saveSegments();
  renderScript(S.currentScriptData);
}

async function removeSection(idx) {
  if (!S.currentScriptData) return;
  S.currentScriptData.segments.splice(idx, 1);
  S.currentScriptData.segments.forEach((s, i) => s.order_index = i);
  await saveSegments();
  renderScript(S.currentScriptData);
}

async function saveSegments() {
  if (!S.currentScript || !S.currentScriptData) return;
  try {
    await apiPost(`/script/${S.currentScript}/update-segments`, {
      segments: S.currentScriptData.segments.map((s, i) => ({
        clip_id: s.clip_id, start_time: s.start_time, end_time: s.end_time,
        section_name: s.section_name, order_index: i, notes: s.notes || '', transition: s.transition || 'cut'
      }))
    });
  } catch(e) {}
}

async function deleteScript() {
  if (!S.currentScript) return;
  if (!confirm('Delete this script?')) return;
  await api(`/script/${S.currentScript}`, {method:'DELETE'});
  toast('Script deleted', 'info');
  renderScriptEmpty();
  loadScriptsList();
}

async function deleteAllScripts() {
  if (!S.scripts || S.scripts.length === 0) { toast('No scripts to delete', 'info'); return; }
  if (!confirm(`Delete ALL ${S.scripts.length} scripts? This cannot be undone.`)) return;
  for (const s of S.scripts) {
    await api(`/script/${s.id}`, {method:'DELETE'});
  }
  toast(`Deleted ${S.scripts.length} scripts`, 'info');
  renderScriptEmpty();
  loadScriptsList();
}

async function duplicateScript() {
  if (!S.currentScriptData) return;
  const script = S.currentScriptData.script;
  const res = await apiPost('/scripts', { name: script.name + ' (copy)', description: script.description, target_duration: script.target_duration_seconds });
  if (res.id) {
    await apiPost(`/script/${res.id}/update-segments`, {
      segments: S.currentScriptData.segments.map((s, i) => ({
        clip_id: s.clip_id, start_time: s.start_time, end_time: s.end_time,
        section_name: s.section_name, order_index: i, notes: s.notes || '', transition: s.transition || 'cut'
      }))
    });
    toast('Script duplicated', 'success');
    await loadScriptsList();
    $('#scriptSelect').value = res.id;
    loadScript(res.id);
  }
}

// ‚îÄ‚îÄ TIMELINE TAB ‚îÄ‚îÄ
function openInTimeline() {
  if (!S.currentScriptData) return;
  S.timelineScript = S.currentScriptData;
  S.timelineSegmentIndex = 0;
  switchTab('timeline');
}

function renderTimeline() {
  const data = S.timelineScript;
  if (!data) {
    $('#timelineScriptPanel').innerHTML = '<div style="padding:40px;color:var(--text3);text-align:center">No script loaded. Go to Scripts tab first.</div>';
    $('#filmstrip').innerHTML = '';
    return;
  }
  const script = data.script;
  const segments = data.segments || [];
  const totalDur = segments.reduce((a, s) => a + ((s.end_time||0) - (s.start_time||0)), 0);

  $('#timelineTitle').textContent = script.name;
  $('#timelineDuration').textContent = fmtDurLong(totalDur);

  // Script panel
  let lastSection = '';
  let html = '';
  segments.forEach((seg, i) => {
    if (seg.section_name && seg.section_name !== lastSection) {
      html += `<div class="tl-section-header">${escHtml(seg.section_name)}</div>`;
      lastSection = seg.section_name;
    }
    html += `
      <div class="tl-segment ${i === S.timelineSegmentIndex ? 'active' : ''}" onclick="selectTimelineSegment(${i})">
        <img class="tl-segment-thumb" src="/api/thumbnails/${seg.clip_id}" onerror="this.style.background='var(--surface2)'">
        <div class="tl-segment-content">
          <div class="tl-segment-speaker">${escHtml(seg.filename || '')}</div>
          <div class="tl-segment-text">${escHtml(seg.transcript_text || seg.notes || '‚Ä¶')}</div>
        </div>
        <div class="tl-segment-tc">${fmtDur(seg.start_time)}</div>
      </div>
    `;
  });
  $('#timelineScriptPanel').innerHTML = html;

  // Filmstrip
  const maxDur = Math.max(...segments.map(s => (s.end_time||0)-(s.start_time||0)), 1);
  $('#filmstrip').innerHTML = segments.map((seg, i) => {
    const dur = (seg.end_time||0) - (seg.start_time||0);
    const w = Math.max(80, Math.round((dur / maxDur) * 200));
    return `
      <div class="filmstrip-block ${i === S.timelineSegmentIndex ? 'active' : ''}" style="min-width:${w}px;border-left:3px solid ${clipColor(seg.clip_id)}" onclick="selectTimelineSegment(${i})">
        <img class="filmstrip-thumb" src="/api/thumbnails/${seg.clip_id}" onerror="this.style.background='var(--bg)'">
        <div class="filmstrip-text">${escHtml((seg.transcript_text || seg.notes || '').slice(0,30))}</div>
        <div class="filmstrip-dur">${fmtDur(dur)}</div>
      </div>
    `;
  }).join('') + `<div class="filmstrip-total">${fmtDurLong(totalDur)}</div>`;

  // Preview
  if (segments.length) selectTimelineSegment(S.timelineSegmentIndex);
}

function selectTimelineSegment(idx) {
  const data = S.timelineScript;
  if (!data || !data.segments) return;
  S.timelineSegmentIndex = idx;
  const seg = data.segments[idx];
  if (!seg) return;

  // Update active states
  $$('.tl-segment').forEach((el, i) => el.classList.toggle('active', i === idx));
  $$('.filmstrip-block').forEach((el, i) => el.classList.toggle('active', i === idx));

  // Scroll active segment into view
  const activeEl = $$('.tl-segment')[idx];
  if (activeEl) activeEl.scrollIntoView({behavior:'smooth', block:'nearest'});
  const activeFilm = $$('.filmstrip-block')[idx];
  if (activeFilm) activeFilm.scrollIntoView({behavior:'smooth', block:'nearest', inline:'center'});

  // Preview
  $('#previewFrame').innerHTML = `<img src="/api/thumbnails/${seg.clip_id}" onerror="this.parentElement.innerHTML='<div class=preview-placeholder>No thumbnail</div>'">`;
  $('#previewInfo').innerHTML = `
    <div class="preview-clip-name">${escHtml(seg.filename || '‚Äî')}</div>
    <div class="preview-clip-tc">${fmtDur(seg.start_time)} ‚Üí ${fmtDur(seg.end_time)}</div>
  `;
  const dur = (seg.end_time||0) - (seg.start_time||0);
  $('#previewSegmentInfo').textContent = `${seg.section_name || ''} ¬∑ ${fmtDurLong(dur)} ¬∑ Segment ${idx+1} of ${data.segments.length}`;
}

function prevSegment() {
  if (S.timelineSegmentIndex > 0) selectTimelineSegment(S.timelineSegmentIndex - 1);
}
function nextSegment() {
  const segs = S.timelineScript?.segments;
  if (segs && S.timelineSegmentIndex < segs.length - 1) selectTimelineSegment(S.timelineSegmentIndex + 1);
}

async function sendToResolve() {
  if (!S.timelineScript) return;
  const btn = event.target;
  btn.disabled = true; btn.textContent = 'Sending‚Ä¶';
  try {
    const res = await apiPost(`/export/resolve/${S.timelineScript.script.id}`, {});
    if (res.error) { toast(res.error, 'error'); }
    else toast(`Timeline "${res.timeline_name}" created ‚Äî ${res.segments_added} segments`, 'success');
  } catch(e) { toast('Export failed: ' + e.message, 'error'); }
  finally { btn.disabled = false; btn.textContent = 'üé¨ Send to Resolve'; }
}

async function exportEDL() {
  if (!S.timelineScript) return;
  try {
    const r = await fetch(`/api/export/edl/${S.timelineScript.script.id}`, {method:'POST'});
    const blob = await r.blob();
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `script_${S.timelineScript.script.id}.edl`;
    a.click();
    toast('EDL downloaded', 'success');
  } catch(e) { toast('EDL export failed', 'error'); }
}

// ‚îÄ‚îÄ Actions ‚îÄ‚îÄ
async function doIngest() {
  toast('Rescanning‚Ä¶', 'info');
  await apiPost('/ingest', {});
  await loadAll();
  toast('Rescan complete', 'success');
}

async function doTranscribe() {
  const btn = $('#transcribeBtn');
  btn.disabled = true; btn.innerHTML = '<span class="spinner"></span> Starting‚Ä¶';
  try {
    const res = await apiPost('/transcribe', {method: 'whisper'});
    toast(`Transcription started (${res.method})`, 'info');
    pollTranscription();
  } catch(e) { toast('Transcription failed: ' + e.message, 'error'); btn.disabled = false; btn.textContent = 'Transcribe All'; }
}

function pollTranscription() {
  const poll = async () => {
    try {
      const p = await api('/transcribe/progress');
      const btn = $('#transcribeBtn');
      if (p.running) {
        btn.innerHTML = `<span class="spinner"></span> ${p.done}/${p.total} ${p.current||''}`;
        setTimeout(poll, 2000);
      } else {
        btn.disabled = false; btn.textContent = 'Transcribe All';
        await loadAll();
        toast('Transcription complete', 'success');
      }
    } catch(e) { setTimeout(poll, 3000); }
  };
  setTimeout(poll, 2000);
}

// ‚îÄ‚îÄ Script Title Save ‚îÄ‚îÄ
async function saveScriptTitle(newTitle) {
  if (!S.currentScript || !newTitle.trim()) return;
  try {
    await fetch(`/api/script/${S.currentScript}`, {
      method: 'PUT',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({name: newTitle.trim()})
    });
    if (S.currentScriptData) S.currentScriptData.script.name = newTitle.trim();
    loadScriptsList(); // refresh dropdown
  } catch(e) { toast('Save failed', 'error'); }
}

// ‚îÄ‚îÄ Clip Field Save ‚îÄ‚îÄ
async function saveClipField(clipId, field, value) {
  try {
    await fetch(`/api/clip/${clipId}`, {
      method: 'PUT',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({[field]: value})
    });
    // Update local state
    const clip = S.clips.find(c => c.id === clipId);
    if (clip) clip[field] = value;
    renderClips();
    renderClipSelector();
  } catch(e) { toast('Save failed', 'error'); }
}

// ‚îÄ‚îÄ Clip Info Modal ‚îÄ‚îÄ
async function showClipInfoModal(id) {
  const clip = S.clips.find(c => c.id === id);
  if (!clip) return;
  document.getElementById('clipInfoTitle').textContent = clip.filename;
  let html = `
    <img src="/api/thumbnails/${id}" style="width:100%;aspect-ratio:16/9;object-fit:cover;border-radius:var(--radius);background:var(--surface2);margin-bottom:16px" onerror="this.style.display='none'">
    <div style="margin-bottom:16px">
      <label style="font-size:11px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:0.5px">Title</label>
      <input type="text" id="clipTitleEdit" value="${escHtml(clip.ai_title || '')}" placeholder="Add a title..." 
        style="width:100%;font-size:15px;font-weight:600;margin-top:4px"
        onchange="saveClipField(${id},'ai_title',this.value)">
    </div>
    <div style="margin-bottom:16px">
      <label style="font-size:11px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:0.5px">Summary</label>
      <input type="text" id="clipSummaryEdit" value="${escHtml(clip.ai_summary || '')}" placeholder="Add a summary..."
        style="width:100%;font-size:13px;margin-top:4px"
        onchange="saveClipField(${id},'ai_summary',this.value)">
    </div>
    <div style="display:grid;grid-template-columns:auto 1fr;gap:6px 16px;font-size:13px;margin-bottom:20px">
      <span style="color:var(--text2)">Duration</span><span style="font-weight:600">${fmtDurLong(clip.duration_seconds)}</span>
      <span style="color:var(--text2)">Resolution</span><span style="font-weight:600">${clip.resolution || '‚Äî'}</span>
      <span style="color:var(--text2)">FPS</span><span style="font-weight:600">${clip.fps || '‚Äî'}</span>
      <span style="color:var(--text2)">Codec</span><span style="font-weight:600">${clip.codec || '‚Äî'}</span>
      <span style="color:var(--text2)">Camera</span><span style="font-weight:600">${clip.camera || '‚Äî'}</span>
      <span style="color:var(--text2)">Path</span><span style="font-weight:600;word-break:break-all">${escHtml(clip.relative_path || clip.filename)}</span>
      <span style="color:var(--text2)">Transcribed</span><span style="font-weight:600">${clip.has_transcript ? '‚úÖ Yes' : '‚ùå No'}</span>
    </div>
  `;
  // Load transcript
  if (clip.has_transcript) {
    try {
      const t = await api('/transcript/' + id);
      if (t && t.segments && t.segments.length) {
        html += '<div style="font-size:12px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:8px">Transcript</div>';
        html += '<div style="max-height:300px;overflow-y:auto;padding:12px;background:var(--surface2);border-radius:var(--radius);font-size:13px;line-height:1.8">';
        html += t.segments.map(s => `<span style="color:var(--text3);font-size:11px;font-variant-numeric:tabular-nums">${fmtDur(s.start)}</span> ${escHtml(s.text)}`).join('<br>');
        html += '</div>';
      }
    } catch(e) {}
  }
  document.getElementById('clipInfoBody').innerHTML = html;
  document.getElementById('clipInfoModal').style.display = 'flex';
}

// ‚îÄ‚îÄ New Script Modal ‚îÄ‚îÄ
function showNewScriptModal() {
  const sel = S.selectedClips || new Set();
  const selClips = S.clips.filter(c => sel.has(c.id));
  const dur = selClips.reduce((a, c) => a + (c.duration_seconds || 0), 0);
  document.getElementById('modalClipSummary').innerHTML = sel.size
    ? `<strong>${sel.size}</strong> clips selected ¬∑ ${fmtDur(dur)} total`
    : '<span style="color:var(--accent)">No clips selected ‚Äî all clips will be used</span>';
  document.getElementById('newScriptModal').style.display = 'flex';
}
function hideNewScriptModal() {
  document.getElementById('newScriptModal').style.display = 'none';
}

// ‚îÄ‚îÄ Folder Picker ‚îÄ‚îÄ
let browseCurrentPath = '';

async function checkProject() {
  showLoading('Starting up‚Ä¶', 'Checking for open project');
  try {
    const project = await api('/project');
    showApp();
    await loadAll();
  } catch(e) {
    hideLoading();
    showFolderPicker();
  }
}

function showFolderPicker() {
  document.getElementById('folderPicker').style.display = 'flex';
  document.getElementById('appMain').style.display = 'none';
  loadRecents();
  browseTo(null); // Start at home directory
}

function showApp() {
  document.getElementById('folderPicker').style.display = 'none';
  document.getElementById('appMain').style.display = 'flex';
}

async function loadRecents() {
  try {
    const recents = await fetch('/api/projects/recent').then(r => r.json());
    const el = document.getElementById('recentProjects');
    if (!recents || !recents.length) { el.innerHTML = ''; return; }
    el.innerHTML = `
      <div style="font-size:13px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:10px">Recent Projects</div>
      ${recents.map(r => `
        <div onclick="openFolder('${r.path.replace(/'/g, "\\'")}')" style="display:flex;align-items:center;gap:12px;padding:12px 16px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:6px;cursor:pointer;transition:all var(--transition)" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'">
          <div style="font-size:22px">üìÅ</div>
          <div style="flex:1;min-width:0">
            <div style="font-size:14px;font-weight:600">${r.name}</div>
            <div style="font-size:12px;color:var(--text3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${r.path}</div>
          </div>
          <div style="color:var(--text3);font-size:11px">${r.opened_at ? new Date(r.opened_at * 1000).toLocaleDateString() : ''}</div>
        </div>
      `).join('')}
    `;
  } catch(e) {}
}

async function browseTo(path) {
  try {
    const url = path ? `/api/browse?path=${encodeURIComponent(path)}` : '/api/browse';
    const data = await fetch(url).then(r => r.json());
    if (data.error) { toast(data.error, 'error'); return; }
    browseCurrentPath = data.path;
    document.getElementById('browsePath').value = data.path;
    document.getElementById('browseUp').disabled = !data.parent;

    // Check if current folder has videos
    const hasVideoHere = data.dirs.some(d => false); // We check via open
    // Show open button if there are video-containing subdirs or we want to let user try
    document.getElementById('openFolderBtn').style.display = 'inline-flex';

    const list = document.getElementById('browseList');
    if (!data.dirs.length) {
      list.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text3)">No subfolders</div>';
      return;
    }
    list.innerHTML = data.dirs.map(d => `
      <div onclick="browseTo('${d.path.replace(/'/g, "\\'")}')" 
           style="display:flex;align-items:center;gap:10px;padding:10px 16px;cursor:pointer;border-bottom:1px solid var(--border);transition:background var(--transition);${d.has_video ? 'background:rgba(74,222,128,0.05)' : ''}"
           onmouseover="this.style.background='var(--surface2)'" onmouseout="this.style.background='${d.has_video ? 'rgba(74,222,128,0.05)' : ''}'">
        <span style="font-size:16px">${d.has_video ? 'üé¨' : 'üìÅ'}</span>
        <span style="flex:1;font-size:13px;${d.has_video ? 'color:var(--green);font-weight:600' : ''}">${d.name}</span>
        ${d.has_video ? '<span style="font-size:11px;color:var(--green)">has videos</span>' : ''}
        <span style="color:var(--text3);font-size:14px">‚Ä∫</span>
      </div>
    `).join('');
  } catch(e) { toast('Browse failed: ' + e.message, 'error'); }
}

function browseUp() {
  const parts = browseCurrentPath.split('/');
  if (parts.length > 1) {
    parts.pop();
    browseTo(parts.join('/') || '/');
  }
}

async function openCurrentFolder() {
  await openFolder(browseCurrentPath);
}

async function openFolder(path) {
  showLoading('Opening project‚Ä¶', path.split('/').pop());
  try {
    const res = await fetch('/api/project/open', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({path})
    });
    const data = await res.json();
    if (data.error) {
      hideLoading();
      toast(data.error, 'error');
      return;
    }
    updateLoading('Scanning clips‚Ä¶', `${data.clip_count} clips found`);
    showApp();
    await loadAll();
    toast(`Opened ${data.name} ‚Äî ${data.clip_count} clips`, 'success');
  } catch(e) {
    hideLoading();
    toast('Failed to open: ' + e.message, 'error');
  }
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
checkProject();

// Also load transcript text for script segments (the API may not include it)
// We'll enrich script data with transcript text when loading scripts
const _origLoadScript = loadScript;
loadScript = async function(id) {
  if (!id) { renderScriptEmpty(); return; }
  try {
    const data = await api(`/script/${id}`);
    // Enrich segments with transcript text
    for (const seg of (data.segments || [])) {
      if (!seg.transcript_text && seg.clip_id) {
        try {
          if (!S.transcripts[seg.clip_id]) {
            S.transcripts[seg.clip_id] = await api(`/transcript/${seg.clip_id}`);
          }
          const t = S.transcripts[seg.clip_id];
          if (t && t.segments) {
            const matching = t.segments.filter(ts =>
              ts.start >= (seg.start_time - 0.5) && ts.end <= (seg.end_time + 0.5)
            );
            seg.transcript_text = matching.map(m => m.text).join(' ') || '';
          }
        } catch(e) {}
      }
    }
    S.currentScript = id;
    S.currentScriptData = data;
    renderScript(data);
  } catch(e) { toast('Failed to load script', 'error'); }
};
// ‚îÄ‚îÄ Help ‚îÄ‚îÄ
function openHelp() {
  document.getElementById('helpModal').style.display = 'flex';
}

// ‚îÄ‚îÄ Settings / Admin ‚îÄ‚îÄ
async function openSettings() {
  const modal = document.getElementById('settingsModal');
  modal.style.display = 'flex';
  // Load stats
  try {
    const stats = await api('/admin/project-stats');
    document.getElementById('settingsContent').innerHTML = `
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:24px">
        <div style="background:var(--surface2);border-radius:8px;padding:16px">
          <div style="font-size:11px;color:var(--text3);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px">Project Folder</div>
          <div style="font-size:13px;color:var(--text);word-break:break-all">${stats.project_dir || '‚Äî'}</div>
        </div>
        <div style="background:var(--surface2);border-radius:8px;padding:16px">
          <div style="font-size:11px;color:var(--text3);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px">Data Location</div>
          <div style="font-size:13px;color:var(--text);word-break:break-all">${stats.rf_dir || '‚Äî'}</div>
        </div>
        <div style="background:var(--surface2);border-radius:8px;padding:16px">
          <div style="font-size:11px;color:var(--text3);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px">Clips</div>
          <div style="font-size:20px;font-weight:700;color:var(--text)">${stats.clips} <span style="font-size:13px;font-weight:400;color:var(--text2)">(${stats.transcribed} transcribed)</span></div>
        </div>
        <div style="background:var(--surface2);border-radius:8px;padding:16px">
          <div style="font-size:11px;color:var(--text3);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px">Scripts</div>
          <div style="font-size:20px;font-weight:700;color:var(--text)">${stats.scripts} <span style="font-size:13px;font-weight:400;color:var(--text2)">(${stats.segments} segments)</span></div>
        </div>
        <div style="background:var(--surface2);border-radius:8px;padding:16px">
          <div style="font-size:11px;color:var(--text3);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px">Database Size</div>
          <div style="font-size:20px;font-weight:700;color:var(--text)">${stats.db_size_mb} MB</div>
        </div>
        <div style="background:var(--surface2);border-radius:8px;padding:16px">
          <div style="font-size:11px;color:var(--text3);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px">Thumbnails</div>
          <div style="font-size:20px;font-weight:700;color:var(--text)">${stats.thumb_size_mb} MB</div>
        </div>
      </div>
      <div style="border-top:1px solid var(--border);padding-top:20px;display:flex;flex-direction:column;gap:12px">
        <h4 style="font-size:13px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:0.5px;margin:0">Actions</h4>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn btn-secondary" onclick="doChangeFolder()">üìÅ Change Folder</button>
          <button class="btn btn-secondary" onclick="doDeleteAllScripts()" style="color:#f59e0b">üóë Delete All Scripts</button>
          <button class="btn btn-secondary" onclick="doResetProject(true)" style="color:#f97316">‚ôª Reset Scripts Only</button>
          <button class="btn btn-secondary" onclick="doResetProject(false)" style="color:#ef4444">‚ö† Full Reset</button>
        </div>
        <div style="font-size:11px;color:var(--text3);margin-top:4px">
          <b>Change Folder</b> ‚Äî switch to a different video project<br>
          <b>Delete All Scripts</b> ‚Äî remove all AI scripts, keep clips &amp; transcripts<br>
          <b>Reset Scripts Only</b> ‚Äî clear scripts, keep clips &amp; transcripts<br>
          <b>Full Reset</b> ‚Äî wipe everything (clips, transcripts, scripts) and re-scan folder
        </div>
      </div>
    `;
  } catch(e) {
    document.getElementById('settingsContent').innerHTML = '<div style="color:var(--text3)">Failed to load project stats</div>';
  }
}

async function doChangeFolder() {
  if (!confirm('Close current project and switch to a different folder?')) return;
  try {
    await apiPost('/admin/change-folder', {});
    document.getElementById('settingsModal').style.display = 'none';
    // Show the folder picker (onboarding)
    document.getElementById('appMain').style.display = 'none';
    document.getElementById('onboarding').style.display = 'flex';
    loadRecents();
  } catch(e) { toast('Failed to change folder', 'error'); }
}

async function exitProject() {
  try {
    await apiPost('/admin/change-folder', {});
    document.getElementById('appMain').style.display = 'none';
    document.getElementById('onboarding').style.display = 'flex';
    loadRecents();
  } catch(e) { toast('Failed to close project', 'error'); }
}

async function doDeleteAllScripts() {
  const count = document.querySelectorAll('.script-item')?.length || '?';
  if (!confirm(`Delete ALL scripts? This cannot be undone.`)) return;
  try {
    await api('/admin/delete-all-scripts', {method:'DELETE'});
    toast('All scripts deleted');
    document.getElementById('settingsModal').style.display = 'none';
    await loadScriptsList();
  } catch(e) { console.error('Delete scripts error:', e); toast('Failed to delete scripts: ' + e.message, 'error'); }
}

async function doResetProject(keepTranscripts) {
  const msg = keepTranscripts
    ? 'Reset all scripts? Clips and transcripts will be kept.'
    : 'FULL RESET ‚Äî this will delete ALL data (clips, transcripts, scripts) and re-scan the folder. Are you sure?';
  if (!confirm(msg)) return;
  if (!keepTranscripts && !confirm('This is irreversible. Type OK to confirm.')) return;
  try {
    document.getElementById('settingsModal').style.display = 'none';
    showLoading(keepTranscripts ? 'Resetting scripts‚Ä¶' : 'Full reset‚Ä¶', 'Re-scanning project');
    const res = await apiPost('/admin/reset-project', { keep_transcripts: keepTranscripts });
    await loadAll();
    toast(keepTranscripts ? 'Scripts reset' : 'Full project reset', 'success');
  } catch(e) { hideLoading(); console.error('Reset error:', e); toast('Failed to reset: ' + e.message, 'error'); }
}
</script>

<!-- Help Modal -->
<div id="helpModal" style="display:none;position:fixed;inset:0;z-index:500;background:rgba(0,0,0,0.6);backdrop-filter:blur(4px);align-items:center;justify-content:center" onclick="if(event.target===this)this.style.display='none'">
  <div style="background:var(--bg);border-radius:12px;width:min(700px,90vw);max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.5)">
    <div style="display:flex;align-items:center;padding:20px 24px;border-bottom:1px solid var(--border)">
      <h3 style="font-size:16px;font-weight:700;flex:1;margin:0">Getting Started with ResolveFlow</h3>
      <button class="btn btn-ghost" onclick="document.getElementById('helpModal').style.display='none'" style="font-size:18px;width:32px;height:32px;display:flex;align-items:center;justify-content:center">‚úï</button>
    </div>
    <div style="padding:24px;font-size:13px;line-height:1.7;color:var(--text)">

      <h4 style="font-size:14px;font-weight:700;color:var(--accent);margin:0 0 12px">What is ResolveFlow?</h4>
      <p style="margin:0 0 20px;color:var(--text2)">ResolveFlow is an AI video script editor built on DaVinci Resolve Studio. Point it at a folder of video clips, transcribe them using Resolve's native transcription, then use AI to generate edits ‚Äî all from your browser.</p>

      <h4 style="font-size:14px;font-weight:700;color:var(--accent);margin:0 0 12px">Requirements</h4>
      <div style="background:var(--surface2);border-radius:8px;padding:16px;margin-bottom:20px">
        <div style="display:grid;gap:8px">
          <div>‚úÖ <b>Python 3.10+</b> ‚Äî no packages needed, pure stdlib</div>
          <div>‚úÖ <b>DaVinci Resolve Studio</b> ‚Äî must be running for transcription &amp; export</div>
          <div>‚úÖ <b>ffmpeg</b> ‚Äî for speech trimming (<code style="background:var(--surface);padding:2px 6px;border-radius:4px;font-size:12px">brew install ffmpeg</code>)</div>
          <div>‚úÖ <b>OpenAI API key</b> ‚Äî for AI script generation</div>
        </div>
      </div>

      <h4 style="font-size:14px;font-weight:700;color:var(--accent);margin:0 0 12px">Step-by-Step Workflow</h4>
      <div style="display:grid;gap:16px;margin-bottom:20px">
        <div style="display:flex;gap:12px;align-items:flex-start">
          <div style="background:var(--accent);color:#000;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;flex-shrink:0">1</div>
          <div>
            <b>Open DaVinci Resolve Studio</b><br>
            <span style="color:var(--text2)">Launch Resolve and create or open a project. Import your video clips into the Media Pool. The project name doesn't need to match your folder ‚Äî ResolveFlow finds clips by filename.</span>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:flex-start">
          <div style="background:var(--accent);color:#000;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;flex-shrink:0">2</div>
          <div>
            <b>Start ResolveFlow</b><br>
            <span style="color:var(--text2)">Run from Terminal:</span>
            <div style="background:var(--surface);padding:10px 14px;border-radius:6px;margin-top:6px;font-family:monospace;font-size:12px">
              export OPENAI_API_KEY="sk-..."<br>
              python3 resolveflow.py /path/to/videos
            </div>
            <span style="color:var(--text2)">Or start without a path and pick the folder from the UI.</span>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:flex-start">
          <div style="background:var(--accent);color:#000;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;flex-shrink:0">3</div>
          <div>
            <b>Transcribe Clips</b><br>
            <span style="color:var(--text2)">Click <b>Transcribe All</b> in the header. ResolveFlow creates a temporary timeline per clip in Resolve, runs native transcription, reads back the subtitle data, then cleans up. This is free and frame-accurate.</span>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:flex-start">
          <div style="background:var(--accent);color:#000;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;flex-shrink:0">4</div>
          <div>
            <b>Generate AI Scripts</b><br>
            <span style="color:var(--text2)">Go to the <b>Scripts</b> tab ‚Üí <b>+ New Script</b>. Select which clips to include, set a target duration and style (highlight, documentary, etc.), and let AI arrange the edit. The AI can only use existing transcript text ‚Äî it never creates new dialog.</span>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:flex-start">
          <div style="background:var(--accent);color:#000;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;flex-shrink:0">5</div>
          <div>
            <b>Review &amp; Edit</b><br>
            <span style="color:var(--text2)">Review the script in the two-column view (outline + full text). Click words to select them, then <b>Cut</b> to remove. Use <b>Refine with AI</b> to iterate ("make it punchier", "cut the intro shorter").</span>
          </div>
        </div>
        <div style="display:flex;gap:12px;align-items:flex-start">
          <div style="background:var(--accent);color:#000;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;flex-shrink:0">6</div>
          <div>
            <b>Export to Resolve</b><br>
            <span style="color:var(--text2)">Click <b>Send to Resolve</b> ‚Äî a new timeline is created in your Resolve project with all the clips placed at the right in/out points. From there, polish in Resolve as usual.</span>
          </div>
        </div>
      </div>

      <h4 style="font-size:14px;font-weight:700;color:var(--accent);margin:0 0 12px">Do I need Resolve running?</h4>
      <div style="background:var(--surface2);border-radius:8px;padding:16px;margin-bottom:20px">
        <div style="display:grid;gap:8px">
          <div>üü¢ <b>Browsing clips &amp; reading transcripts</b> ‚Äî No, works without Resolve</div>
          <div>üü¢ <b>AI script generation &amp; editing</b> ‚Äî No, works without Resolve</div>
          <div>üü¢ <b>Word-level cutting</b> ‚Äî No, works without Resolve</div>
          <div>üî¥ <b>Transcribing clips</b> ‚Äî Yes, Resolve Studio must be open</div>
          <div>üî¥ <b>Exporting to timeline</b> ‚Äî Yes, Resolve Studio must be open</div>
        </div>
        <p style="margin:12px 0 0;color:var(--text3);font-size:12px">The green dot in the header shows Resolve connection status. If it's red, open Resolve and it will reconnect automatically.</p>
      </div>

      <h4 style="font-size:14px;font-weight:700;color:var(--accent);margin:0 0 12px">Portable Projects</h4>
      <p style="margin:0 0 8px;color:var(--text2)">All project data is stored in a <code style="background:var(--surface);padding:2px 6px;border-radius:4px;font-size:12px">.resolveflow/</code> folder inside your video directory. Move the drive to another machine with ResolveFlow installed, open the folder, and pick up where you left off ‚Äî transcripts, scripts, and edits all travel with your footage.</p>

      <h4 style="font-size:14px;font-weight:700;color:var(--accent);margin:0 0 12px">Keyboard Shortcuts</h4>
      <div style="background:var(--surface2);border-radius:8px;padding:16px">
        <div style="display:grid;grid-template-columns:auto 1fr;gap:6px 16px">
          <kbd style="background:var(--surface);padding:2px 8px;border-radius:4px;font-size:11px;font-family:monospace">Click + Drag</kbd><span style="color:var(--text2)">Select words in script for cutting</span>
          <kbd style="background:var(--surface);padding:2px 8px;border-radius:4px;font-size:11px;font-family:monospace">Native Select</kbd><span style="color:var(--text2)">Browser text selection also works for word cuts</span>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" style="display:none;position:fixed;inset:0;z-index:500;background:rgba(0,0,0,0.6);backdrop-filter:blur(4px);align-items:center;justify-content:center" onclick="if(event.target===this)this.style.display='none'">
  <div style="background:var(--bg);border-radius:12px;width:min(640px,90vw);max-height:80vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.5)">
    <div style="display:flex;align-items:center;padding:20px 24px;border-bottom:1px solid var(--border)">
      <h3 style="font-size:16px;font-weight:700;flex:1;margin:0">‚öô Settings</h3>
      <button class="btn btn-ghost" onclick="document.getElementById('settingsModal').style.display='none'" style="font-size:18px;width:32px;height:32px;display:flex;align-items:center;justify-content:center">‚úï</button>
    </div>
    <div id="settingsContent" style="padding:24px">
      <div style="color:var(--text3)">Loading...</div>
    </div>
  </div>
</div>

</body>
</html>
