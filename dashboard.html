<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Resolve Dashboard</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
:root { --bg: #0f1117; --surface: #1a1d27; --surface2: #242836; --border: #2e3348; --text: #e1e4ed; --text2: #8b90a5; --accent: #6366f1; --accent2: #818cf8; --green: #22c55e; --orange: #f59e0b; --red: #ef4444; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); }
.app { display: flex; height: 100vh; }
.sidebar { width: 220px; background: var(--surface); border-right: 1px solid var(--border); padding: 16px; flex-shrink: 0; }
.sidebar h1 { font-size: 16px; margin-bottom: 24px; color: var(--accent2); }
.sidebar button { display: block; width: 100%; padding: 10px 12px; background: none; border: none; color: var(--text2); text-align: left; cursor: pointer; border-radius: 6px; font-size: 14px; margin-bottom: 2px; }
.sidebar button:hover, .sidebar button.active { background: var(--surface2); color: var(--text); }
.main { flex: 1; overflow-y: auto; padding: 24px; }
.panel { display: none; }
.panel.active { display: block; }
h2 { font-size: 20px; margin-bottom: 16px; }
.search-bar { width: 100%; padding: 10px 14px; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 14px; margin-bottom: 16px; outline: none; }
.search-bar:focus { border-color: var(--accent); }

/* Clip Grid */
.clip-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 12px; }
.clip-card { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 14px; cursor: pointer; transition: border-color 0.2s; }
.clip-card:hover { border-color: var(--accent); }
.clip-card .thumb { height: 100px; background: var(--surface2); border-radius: 6px; display: flex; align-items: center; justify-content: center; color: var(--text2); font-size: 32px; margin-bottom: 10px; }
.clip-card .name { font-weight: 600; font-size: 13px; margin-bottom: 4px; }
.clip-card .meta { font-size: 12px; color: var(--text2); }
.badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
.badge.dji { background: #1e3a5f; color: #60a5fa; }
.badge.sony { background: #3b1f1f; color: #f87171; }

/* Transcript */
.transcript-block { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; margin-bottom: 12px; overflow: hidden; }
.transcript-header { padding: 12px 16px; background: var(--surface2); font-weight: 600; font-size: 13px; display: flex; justify-content: space-between; cursor: pointer; }
.transcript-body { padding: 16px; line-height: 1.8; font-size: 14px; }
.transcript-body .speaker { color: var(--accent2); font-weight: 600; font-size: 12px; margin-right: 6px; }
.highlight { background: #6366f133; border-radius: 2px; padding: 0 2px; }

/* AI Edits */
.btn { padding: 10px 20px; background: var(--accent); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; }
.btn:hover { background: var(--accent2); }
.btn:disabled { opacity: 0.5; cursor: not-allowed; }
.btn-sm { padding: 6px 12px; font-size: 12px; }
.btn-danger { background: var(--red); }
.edit-list { margin-top: 16px; }
.edit-card { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 16px; margin-bottom: 12px; }
.edit-card h3 { font-size: 16px; margin-bottom: 8px; }
.edit-card .date { font-size: 12px; color: var(--text2); margin-bottom: 12px; }
.timeline { display: flex; gap: 2px; height: 40px; border-radius: 6px; overflow: hidden; margin: 12px 0; }
.timeline-seg { display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 600; color: white; min-width: 20px; cursor: pointer; }
.section-detail { background: var(--surface2); border-radius: 8px; padding: 12px; margin: 8px 0; font-size: 13px; }
.section-detail h4 { margin-bottom: 6px; color: var(--accent2); }

/* Modal */
.modal-bg { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 100; }
.modal { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 24px; width: 500px; max-width: 90vw; }
.modal h3 { margin-bottom: 16px; }
.modal input, .modal textarea { width: 100%; padding: 10px; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 14px; margin-bottom: 12px; }
.modal textarea { height: 100px; resize: vertical; }
.modal .actions { display: flex; gap: 8px; justify-content: flex-end; }
.loading { text-align: center; padding: 40px; color: var(--text2); }

/* Clip detail */
.clip-detail { background: var(--surface); border-radius: 10px; padding: 20px; }
.back-btn { background: none; border: none; color: var(--accent2); cursor: pointer; font-size: 14px; margin-bottom: 16px; }
</style>
</head>
<body>
<div class="app">
  <div class="sidebar">
    <h1>üé¨ Resolve</h1>
    <button class="active" onclick="showPanel('clips')">üìÅ Clips</button>
    <button onclick="showPanel('transcript')">üìù Transcript</button>
    <button onclick="showPanel('edits')">‚úÇÔ∏è AI Edits</button>
  </div>
  <div class="main">
    <!-- Clips Panel -->
    <div id="clips-panel" class="panel active">
      <h2>Clips</h2>
      <input class="search-bar" placeholder="Search clips..." oninput="filterClips(this.value)">
      <div id="clip-grid" class="clip-grid"></div>
      <div id="clip-detail" style="display:none"></div>
    </div>
    <!-- Transcript Panel -->
    <div id="transcript-panel" class="panel">
      <h2>Full Transcript</h2>
      <input class="search-bar" placeholder="Search transcript..." oninput="filterTranscript(this.value)">
      <div id="transcript-content"></div>
    </div>
    <!-- AI Edits Panel -->
    <div id="edits-panel" class="panel">
      <h2>AI Edits</h2>
      <button class="btn" onclick="showNewEditModal()">+ Generate AI Edit</button>
      <div id="edits-list" class="edit-list"></div>
    </div>
  </div>
</div>

<!-- New Edit Modal -->
<div id="edit-modal" class="modal-bg" style="display:none" onclick="if(event.target===this)this.style.display='none'">
  <div class="modal">
    <h3>Generate AI Edit</h3>
    <input id="edit-name" placeholder="Edit name">
    <input id="edit-desc" placeholder="Description">
    <textarea id="edit-prompt" placeholder="Custom prompt (optional)"></textarea>
    <div class="actions">
      <button class="btn" onclick="document.getElementById('edit-modal').style.display='none'" style="background:var(--surface2)">Cancel</button>
      <button class="btn" id="generate-btn" onclick="generateEdit()">Generate</button>
    </div>
  </div>
</div>

<script>
const API = 'http://localhost:8081';
let clips = [], fullTranscript = [], aiEdits = [];

async function fetchJSON(url, opts) {
  const r = await fetch(API + url, opts);
  return r.json();
}

// Panel switching
function showPanel(name) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.sidebar button').forEach(b => b.classList.remove('active'));
  document.getElementById(name + '-panel').classList.add('active');
  event.target.classList.add('active');
  if (name === 'clips') { document.getElementById('clip-detail').style.display = 'none'; document.getElementById('clip-grid').style.display = ''; }
}

// Clips
async function loadClips() {
  clips = await fetchJSON('/api/clips');
  renderClips(clips);
}

function renderClips(list) {
  const grid = document.getElementById('clip-grid');
  grid.innerHTML = list.map(c => `
    <div class="clip-card" onclick="showClipDetail(${c.id})">
      <div class="thumb">üé•</div>
      <div class="name">${c.filename}</div>
      <div class="meta">
        <span class="badge ${c.camera}">${c.camera}</span>
        ${c.duration_seconds ? Math.round(c.duration_seconds) + 's' : ''} ¬∑ ${c.resolution || ''} ¬∑ ${c.codec || ''}
      </div>
    </div>
  `).join('');
}

function filterClips(q) {
  q = q.toLowerCase();
  renderClips(clips.filter(c => c.filename.toLowerCase().includes(q) || (c.camera||'').includes(q)));
}

async function showClipDetail(id) {
  const clip = clips.find(c => c.id === id);
  document.getElementById('clip-grid').style.display = 'none';
  const detail = document.getElementById('clip-detail');
  detail.style.display = 'block';
  detail.innerHTML = '<div class="loading">Loading...</div>';

  let transcript = null, diar = [];
  try { transcript = await fetchJSON('/api/transcript/' + id); } catch(e) {}
  try { diar = await fetchJSON('/api/diarization/' + id); } catch(e) {}

  detail.innerHTML = `
    <button class="back-btn" onclick="document.getElementById('clip-detail').style.display='none';document.getElementById('clip-grid').style.display=''">‚Üê Back to clips</button>
    <div class="clip-detail">
      <h2>${clip.filename}</h2>
      <p style="color:var(--text2);margin-bottom:16px">
        <span class="badge ${clip.camera}">${clip.camera}</span>
        ${clip.duration_seconds ? Math.round(clip.duration_seconds) + 's' : ''} ¬∑ ${clip.resolution} ¬∑ ${clip.codec} ¬∑ ${((clip.file_size_bytes||0)/1048576).toFixed(1)} MB
      </p>
      ${transcript && transcript.full_text ? `
        <h3 style="margin-bottom:8px">Transcript</h3>
        <div class="transcript-body">${formatTranscriptWithDiar(transcript.full_text, diar)}</div>
      ` : '<p style="color:var(--text2)">No transcript available</p>'}
    </div>
  `;
}

function formatTranscriptWithDiar(text, diar) {
  if (!diar || !diar.length) return text;
  return diar.map(d => `<span class="speaker">[${d.speaker_label}]</span>${d.text}`).join('<br>');
}

// Transcript
async function loadTranscript() {
  const el = document.getElementById('transcript-content');
  el.innerHTML = '<div class="loading">Loading transcript...</div>';
  fullTranscript = await fetchJSON('/api/transcript/full');
  renderTranscript(fullTranscript, '');
}

function renderTranscript(data, query) {
  const el = document.getElementById('transcript-content');
  el.innerHTML = data.map(t => {
    let text = t.full_text || '';
    if (query) {
      const re = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`, 'gi');
      text = text.replace(re, '<span class="highlight">$1</span>');
    }
    // Merge diarization
    let body = text;
    if (t.diarization && t.diarization.length) {
      body = t.diarization.map(d => `<span class="speaker">[${d.speaker_label}]</span>${highlightText(d.text, query)}`).join('<br>');
    } else if (query) {
      body = text;
    }
    return `
      <div class="transcript-block">
        <div class="transcript-header">
          <span>${t.filename}</span>
          <span style="color:var(--text2)">${t.duration ? Math.round(t.duration) + 's' : ''}</span>
        </div>
        <div class="transcript-body">${body}</div>
      </div>
    `;
  }).join('');
}

function highlightText(text, query) {
  if (!query) return text;
  const re = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`, 'gi');
  return text.replace(re, '<span class="highlight">$1</span>');
}

function filterTranscript(q) {
  if (!q) { renderTranscript(fullTranscript, ''); return; }
  const filtered = fullTranscript.filter(t => (t.full_text||'').toLowerCase().includes(q.toLowerCase()));
  renderTranscript(filtered, q);
}

// AI Edits
const sectionColors = ['#6366f1','#22c55e','#f59e0b','#ef4444','#8b5cf6','#06b6d4','#ec4899','#14b8a6'];

async function loadEdits() {
  aiEdits = await fetchJSON('/api/ai-edits');
  renderEdits();
}

function renderEdits() {
  const el = document.getElementById('edits-list');
  if (!aiEdits.length) { el.innerHTML = '<p style="color:var(--text2);margin-top:16px">No edits yet. Generate one!</p>'; return; }
  el.innerHTML = aiEdits.map(e => {
    let plan;
    try { plan = JSON.parse(e.edit_plan_json); } catch { plan = {}; }
    const sections = plan.sections || [];
    return `
      <div class="edit-card">
        <div style="display:flex;justify-content:space-between;align-items:start">
          <div>
            <h3>${e.name}</h3>
            <div class="date">${e.created_at} ${e.description ? '¬∑ ' + e.description : ''}</div>
          </div>
          <button class="btn btn-sm btn-danger" onclick="deleteEdit(${e.id})">Delete</button>
        </div>
        ${sections.length ? `
          <div class="timeline">
            ${sections.map((s,i) => `<div class="timeline-seg" style="flex:1;background:${sectionColors[i%sectionColors.length]}" title="${s.section_name}">${s.section_name ? s.section_name.substring(0,12) : ''}</div>`).join('')}
          </div>
          ${sections.map((s,i) => `
            <div class="section-detail">
              <h4 style="color:${sectionColors[i%sectionColors.length]}">${s.section_name || 'Section ' + (i+1)}</h4>
              <p>${(s.clips||[]).map(c => `${c.filename} (${c.start_time}s-${c.end_time}s): ${c.reason||''}`).join('<br>')}</p>
              ${s.notes ? `<p style="color:var(--text2);margin-top:4px">${s.notes}</p>` : ''}
            </div>
          `).join('')}
          ${plan.reasoning ? `<p style="color:var(--text2);margin-top:8px;font-size:13px"><strong>Reasoning:</strong> ${plan.reasoning}</p>` : ''}
        ` : '<p style="color:var(--text2)">No sections</p>'}
      </div>
    `;
  }).join('');
}

function showNewEditModal() { document.getElementById('edit-modal').style.display = 'flex'; }

async function generateEdit() {
  const btn = document.getElementById('generate-btn');
  btn.disabled = true; btn.textContent = 'Generating...';
  try {
    await fetchJSON('/api/ai-edit', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        name: document.getElementById('edit-name').value || 'Untitled Edit',
        description: document.getElementById('edit-desc').value,
        prompt: document.getElementById('edit-prompt').value
      })
    });
    document.getElementById('edit-modal').style.display = 'none';
    loadEdits();
  } catch(e) { alert('Error: ' + e.message); }
  btn.disabled = false; btn.textContent = 'Generate';
}

async function deleteEdit(id) {
  if (!confirm('Delete this edit?')) return;
  await fetchJSON('/api/ai-edit/' + id, {method:'DELETE'});
  loadEdits();
}

// Init
loadClips();
loadTranscript();
loadEdits();
</script>
</body>
</html>
